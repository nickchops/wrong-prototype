<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>WRONG Prototype by nickchops</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>WRONG Prototype</h1>
        <h2>Weaponified Reverse pONG - Marmalade Quick demo game - prototype version</h2>
        <a href="https://github.com/nickchops/wrong-prototype" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <p>Hey there! This repository contains the source for a game called "Wrong". Well, actually, in the spirit of Wrong, it's not actually the source to the game at all... yet! Currently this is the source for a prototype version, and the blog below is a getting started guide and walkthrough for building it. Stay tuned for an update where I'll be pushing the full game project and linking from here.</p>

<p>Meanwhile, let's take a look at the prototype and tools it was built with...</p>

<p>The Wrong prototype was built as part of a blog series on getting started with Marmalade Quick, by Marmalade dev advocate, and owner of this GitHub account, Nick Smith (that's me).</p>

<p>Marmalade Quick is 2D Lua based engine that ships with the Marmalade SDK. It allows you to code 2D games quickly using Lua and, combined with the regular Marmalade tools, lets you easily publish to iOS, Android, Windows 8/10 Phone and Store, other PC stores and Mac. Marmalade has some cool features, like the ability to make local iOS builds on a PC, the ability to extend the engine (the C++, Objective-C, C#, Java and Lua parts) and it's free to use.</p>

<p>Check out the original Marmalade blog for more like this: <a href="http://www.madewithmarmalade.com/blog/">http://www.madewithmarmalade.com/blog/</a></p>

<hr>

<h1>
<a id="building-a-marmalade-quick-game-with-nick-smith-part-1-getting-started" class="anchor" href="#building-a-marmalade-quick-game-with-nick-smith-part-1-getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a Marmalade Quick Game with Nick Smith, part 1: Getting Started</h1>

<p>Now that Marmalade Quick is available (<a href="http://www.madewithmarmalade.com/quick">download it right here</a>), I'll be building an app or two with Marmalade Quick and doing regular blog posts detailing the highs and lows encountered on the way. I'll be highlighting features, walking through how to use both tools and APIs, and giving tips and hints for getting the most out of Marmalade Quick. Since we've just gone into the first full release following a public beta version, I'll also be highlighting changes from the beta version, giving updates on new features we've added and previewing what's on the way in the next release.I started using Marmalade Quick in earnest over Christmas, with little-to-no Lua experience and having never worked on any of its internals or design. These blog posts will take us from "What is Marmalade Quick?! What is Lua?!" right through to uploading to the various stores and dropping the source onto GitHub.</p>

<h2>
<a id="so-what-actually-is-quick" class="anchor" href="#so-what-actually-is-quick" aria-hidden="true"><span class="octicon octicon-link"></span></a>So, what actually is Quick?</h2>

<p>Marmalade Quick aims to be the fastest, most flexible, most open way to create cross-platform 2D games and apps for mobile devices.</p>

<p>Marmalade itself is a C++/native SDK for building high-performance apps with a single open-standards API set, and deploying them effortlessly to a wide range of devices - iOS, Android, BlackBerry 10, Windows, Mac... - without needing to use any OS-specific code or tools.</p>

<p>Marmalade Quick is essentially middleware that sits on top of Marmalade and provides a high level, easy-to-use interface via the Lua scripting language. Quick allows you to write interactive apps using 2D graphics, physics and touch interactivity in as little as 15 lines of code. Internally it uses best-in-class C++ modules like Cocos2D and Box2D to do the hard work for you.</p>

<p>Marmalade Quick comes with pre-built C++ apps and open source Lua scripts that combine to load and run your Lua/Quick code. You don't need to touch or understand the C++ parts, but both those and the Lua internals are provided as source, which you can modify and extend if you want. Quick comes with Lua wrappers for the core Marmalade C APIs plus its own 2D graphics and physics APIs. You can essentially extend Marmalade Quick to provide Lua interfaces to any Marmalade C APIs (we'll cover that in a future post!).</p>

<p>Marmalade Quick also has a new Launchpad tool that lets you manage, run and deploy projects from a simple interface without touching an IDE or Marmalade's standard deploy tool.
So what does that mean in practice? Basically, you open the Launchpad, click "New Project", type some simple Lua code in a text editor, and get a 2D game up and running with no C++ or graphics programming knowledge. You can hit "Launch" to test on desktop, "Deploy" to run on devices and "Publish" to spit out a build ready for an app store.</p>

<h2>
<a id="what-you-need-to-use-marmalade-quick" class="anchor" href="#what-you-need-to-use-marmalade-quick" aria-hidden="true"><span class="octicon octicon-link"></span></a>What you need to use Marmalade Quick</h2>

<p>Download, license and install the latest Marmalade SDK build from here: <a href="https://www.madewithmarmalade.com/downloads">https://www.madewithmarmalade.com/downloads</a></p>

<p>New users can sign up for free and use an eval license (eval licenses mean deployed apps will be watermarked and not valid for publishing). You can use Mac or PC for both Marmalade SDK and Quick and you can deploy to all standard platforms with either.</p>

<p><del>Download Marmalade Quick for Windows or Mac from here:</del>
<del><a href="http://www.madewithmarmalade.com/quick">http://www.madewithmarmalade.com/quick</a></del>
<del>Its a zip file, just extract it into the root folder of your 6.2 SDK. It's safe and only adds files (no overwriting). On Mac, make sure you <em>merge</em> folders instead of replacing them! (use terminal with "rsync -arvu " if needed)</del>
<strong>(Quick is now bundled inside the regular Marmalade SDK and requires no additional setup steps)</strong></p>

<p>Documentation for Marmalade Quick is online here:
<del><a href="http://quick-docs.madewithmarmalade.com">http://quick-docs.madewithmarmalade.com</a></del>
<strong>(now at <a href="http://docs.madewithmarmalade.com/display/MD/Marmalade+Quick">http://docs.madewithmarmalade.com/display/MD/Marmalade+Quick</a>)</strong></p>

<p>We don't currently offer offline documentation, <del>but feel free to save them from the browser. Search will work without an Internet connection.</del></p>

<p>Marmalade Quick doesn't need any additional SDKs or even an IDE. You can edit game code in a text editor, the app binary is pre-built for you and your code is compiled automatically at runtime.</p>

<p>As with the regular Marmalade SDK, in order to deploy to devices, you will need:</p>

<ul>
<li>iOS and BlackBerry signing assets and accounts (certificates, profiles etc - we'll cover these in       another post!)</li>
<li>Java runtime for Android and BlackBerry signing</li>
<li>On Mac you need Python 2.6 or newer (python ships built-in with Marmalade for Windows)</li>
</ul>

<h2>
<a id="first-steps" class="anchor" href="#first-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>First steps</h2>

<p>Once Marmalade is installed (and licensed - follow the registration prompt at the end of installation), just go to /quick/tools and run the Quick Launchpad exe/app file from there.</p>

<p>Follow the steps in A Quick App in 5 Minutes in the docs:
<del><a href="http://quick-docs.madewithmarmalade.com/AQuickAppIn5Minutes.html">http://quick-docs.madewithmarmalade.com/AQuickAppIn5Minutes.html</a></del>
<strong>(<a href="http://docs.madewithmarmalade.com/display/MD/A+Quick+App+in+5+Minutes">http://docs.madewithmarmalade.com/display/MD/A+Quick+App+in+5+Minutes</a>)</strong></p>

<p>I'll be walking through some real world code in the next few posts. For now, I'd encourage you to dive in and see what you can build! A good starting point is the examples in quick/data/examples (there's a lot more there than the ones listed by default in the Launchpad).</p>

<p>Quick tip: You don't need to close and re-launch the Simulator when you edit code. Just save your Lua file(s) and hit Ctrl-R in the Simulator to reload the Lua code. Ctrl-T will restart the whole app (useful if you manage to really confuse the Simulator).</p>

<h2>
<a id="where-is-support-for-platform-x" class="anchor" href="#where-is-support-for-platform-x" aria-hidden="true"><span class="octicon octicon-link"></span></a>Where is Support for Platform X?</h2>

<p>Quick is completely platform-independent: There is, for example, no iOS-specific code anywhere in it. Marmalade itself takes care of platform abstraction and so Quick will technically run on <em>all</em> Marmalade-supported devices. However, for Quick we decided to implement a new project management and deployment GUI, the "Quick LaunchPad", which provides a new front end to Marmalade's existing deployment tools. In the initial release, only iOS, Android, BlackBerry PlayBook and BlackBerry 10 are provided in the Launchpad, and not all of the usual Marmalade deployment options (for things like specific icons and permissions) are supported. However, you can still run Marmalade Quick with all existing Marmalade deploy options on all supported platforms...
You'll need to use the standard Deploy Tool in order to access additional platforms and options. You can launch this directly from within the new Launchpad:
In the launchpad, use the Advanced &gt; Launch Deploy Tool option
Under "Stage: Select Build" choose ARM GCC Release for devices or x86 Release for desktop
Under Platform Selection choose the OS/platforms you want to deploy to
Under Configuration, select the options you need (see below)
Under Deploying, do "package" or "package and install" to put on device.
Standard Deployment Tool settings are all documented here
Note that Quick has not been well tested against the Marmalade 6.2 beta SDK for Windows Phone 8 and we are not officially supporting Quick on WP8 yet.</p>

<p><strong>(NB: From Marmalade 7.0, Quick uses the new Marmalade Hub GUI and supports most platforms out of the box. See <a href="http://docs.madewithmarmalade.com/display/MD/What+do+we+support">http://docs.madewithmarmalade.com/display/MD/What+do+we+support</a>)</strong></p>

<hr>

<h1>
<a id="building-a-marmalade-quick-game-with-nick-smith-part-2-getting-to-grips-with-lua" class="anchor" href="#building-a-marmalade-quick-game-with-nick-smith-part-2-getting-to-grips-with-lua" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a Marmalade Quick Game with Nick Smith, part 2: Getting to Grips with Lua</h1>

<p>I'll preface this post by saying that I'm mostly a C++ and Python developer these days. I first used Quick when the alpha release came out and only seriously dove into it over Christmas. Before Quick, I had only ever used Lua to set a few values in scripts for games and had basically no concept of how it actually works; most "issues" I encountered getting to grips with Quick, were actually just getting to grips with Lua!The way I talk about Lua objects and behaviour here is also going to be coloured heavily by my use of C++ and object oriented (OO) programming, so I will definitely be misusing technical terms as much as I possible can. As a first step for users who are new to Lua, I very much recommend that you understand how it handles objects/values, specifically the way that everything is a reference and everything is global by default. With that in mind, for this post I'm going to skip Quick almost entirely and kick off with an idiots guide to Lua.</p>

<h2>
<a id="whitespace-and-block-endings" class="anchor" href="#whitespace-and-block-endings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Whitespace and block endings</h2>

<ul>
<li>Lua uses whitespace only to separate API calls. Unlike Python for example, indentation is irrelevant and only used to make code readable.</li>
<li>Lua does not have any end-of-line characters (like semicolons in C/Java)</li>
<li>Code blocks such as if statements, functions and for loops use the "end" keyword to enclose their content</li>
</ul>

<p>Example:</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span> <span class="pl-en">MyFunction</span>(<span class="pl-smi">value</span>)
    value <span class="pl-k">=</span> value <span class="pl-k">*</span> <span class="pl-c1">5</span>
    <span class="pl-k">if</span> value <span class="pl-k">&gt;</span> <span class="pl-c1">20</span> <span class="pl-k">then</span>
        <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>value &gt; 20<span class="pl-pds">"</span></span>)
    <span class="pl-k">elseif</span> value <span class="pl-k">&gt;</span> <span class="pl-c1">10</span>
        <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>value &gt; 10<span class="pl-pds">"</span></span>)
    <span class="pl-k">end</span>
    <span class="pl-k">if</span> value <span class="pl-k">then</span> <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>value is <span class="pl-pds">"</span></span> <span class="pl-k">..</span> value) <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>Tip: Concatenate strings and numbers using '..' as above.</p>

<h2>
<a id="comments" class="anchor" href="#comments" aria-hidden="true"><span class="octicon octicon-link"></span></a>Comments</h2>

<ul>
<li>Comments are any text following two hyphens (--) in a line.</li>
<li>Multi-line comments start with --[[ and end with ]]--</li>
</ul>

<h2>
<a id="lua-is-small" class="anchor" href="#lua-is-small" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lua is small!</h2>

<ul>
<li>There are no classes, private/public, queues or other fancy data types, etc.</li>
<li>Implement them yourself! Or better, find a module from the web.</li>
<li>Lua has no +=, ++, etc. operators or any shorthand notation. Ctrl-C/V is your friend!</li>
</ul>

<h2>
<a id="value-types" class="anchor" href="#value-types" aria-hidden="true"><span class="octicon octicon-link"></span></a>Value types</h2>

<p>Lua only provides the following types:</p>

<ul>
<li>floating point numbers - there is no integer type and no concept of short vs long, float vs double, etc. Just write the number to declare it</li>
<li>strings - just declare using value="my string here"</li>
<li>tables (access a group of value by keys)</li>
<li>functions</li>
<li>true &amp; false</li>
<li>nil - no object, like null or nil in other languages</li>
<li>Tables</li>
<li>Tables store values (numbers/strings/functions/tables) which are indexed by keys. A key can be any Lua type (string/number/function/table).</li>
</ul>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>mytable <span class="pl-k">=</span> {} <span class="pl-c">--empty table</span>
mytable <span class="pl-k">=</span> {<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>value two<span class="pl-pds">"</span></span>, <span class="pl-c1">7</span>, <span class="pl-c1">5</span>, <span class="pl-s"><span class="pl-pds">"</span>another value<span class="pl-pds">"</span></span>}<span class="pl-c">--table initialised with values - no specified keys means keys are auto-assigned numbers starting at 1 (1,2,3,4, etc)</span>
mytable2 <span class="pl-k">=</span> {name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bob<span class="pl-pds">"</span></span>, age<span class="pl-k">=</span><span class="pl-c1">20</span>, colour<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>orange<span class="pl-pds">"</span></span>} <span class="pl-c">--special case: you can initialise values with string keys like this.</span></pre></div>

<p>You can access table values as follows:</p>

<div class="highlight highlight-lua"><pre><span class="pl-c1">print</span>(mytable[<span class="pl-c1">1</span>]) <span class="pl-c">--prints hello</span>
<span class="pl-c1">print</span>(mytable[<span class="pl-s"><span class="pl-pds">"</span>age<span class="pl-pds">"</span></span>]) <span class="pl-c">--prints 20</span>
<span class="pl-c1">print</span>(mytable.<span class="pl-smi">age</span>) <span class="pl-c">--prints 20</span>
<span class="pl-c1">print</span>(mytable<span class="pl-c1">.1</span>) <span class="pl-c">--error! can't use numbers with the dot operator</span></pre></div>

<p>Dynamic assignment:</p>

<ul>
<li>Variable types are dynamic, so you can do things like:</li>
</ul>

<div class="highlight highlight-lua"><pre>a<span class="pl-k">=</span><span class="pl-c1">1</span> <span class="pl-k">then</span> a<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>string<span class="pl-pds">"</span></span> <span class="pl-k">then</span> a <span class="pl-k">=</span> {} <span class="pl-k">then</span> a <span class="pl-k">=</span> <span class="pl-c1">myFunction</span>()<span class="pl-c1">...</span><span class="pl-k">end</span></pre></div>

<h2>
<a id="nil" class="anchor" href="#nil" aria-hidden="true"><span class="octicon octicon-link"></span></a>nil</h2>

<ul>
<li>You can include an undeclared variable in your code and instead of causing an error/exception, it will just evaluate to nil.</li>
<li>In conditionals (if, while, etc), nil evaluates to false.</li>
<li>Unlike in C, zero is <em>not</em> equivalent to false, so "if 0" evaluates to true.</li>
</ul>

<h2>
<a id="functions" class="anchor" href="#functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functions</h2>

<ul>
<li>Functions objects are declared with the "function" keyword and a parameter list in parentheses "()".</li>
<li>A function with parentheses in your code calls the function.</li>
<li>Specifying it without parentheses treats it as a value that is passed by reference like other objects (see further down).</li>
<li>Parameters are local variables pointing to the object passed to the function (ditto).</li>
</ul>

<p>Example:</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span> <span class="pl-en">myFunction</span>(<span class="pl-smi">someValue</span>)
    <span class="pl-c1">print</span>(someValue)
<span class="pl-k">end</span>

myVar <span class="pl-k">=</span> myFunction
    <span class="pl-c1">myVar</span>(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>) <span class="pl-c">--prints "hello"</span>
    anotherVar <span class="pl-k">=</span> myVar
    <span class="pl-c1">anotherVar</span>(<span class="pl-s"><span class="pl-pds">"</span>goodbye<span class="pl-pds">"</span></span>)

myTable <span class="pl-k">=</span> {}
myTable.<span class="pl-smi">memberFunction</span> <span class="pl-k">=</span> <span class="pl-k">function</span>()
    <span class="pl-c">--do something here</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="references-and-values" class="anchor" href="#references-and-values" aria-hidden="true"><span class="octicon octicon-link"></span></a>References and values</h2>

<ul>
<li>Everything in Lua is an object</li>
<li>Variables are all references that point at these objects, so all variable assignments are by reference!</li>
<li>Strings and numbers are essentially immutable objects, so when you do myVariable="mystring" you are essentially saying "create an object, 'mystring'" and "myVariable is a pointer to that object".</li>
<li>If you have two variables referring to the same string and set the first variable to another string, it wont change the second variable; they are now pointing to different strings.</li>
<li>Think of every unique number or string as a new object defined somewhere inside Lua.</li>
<li>This is why you can use a string as a key in a table and not worry about the key itself changing.</li>
</ul>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>a<span class="pl-k">=</span><span class="pl-c1">5</span>
b<span class="pl-k">=</span>a
c<span class="pl-k">=</span><span class="pl-c1">7</span>
  <span class="pl-k">-&gt;</span> a<span class="pl-k">=</span><span class="pl-c1">5</span>, b<span class="pl-k">=</span><span class="pl-c1">5</span>, c<span class="pl-k">=</span><span class="pl-c1">7</span> (a <span class="pl-k">and</span> b are references to same number!)

a<span class="pl-k">=</span><span class="pl-c1">2</span>
  <span class="pl-k">-&gt;</span> a<span class="pl-k">=</span><span class="pl-c1">2</span>, b<span class="pl-k">=</span><span class="pl-c1">5</span>, c<span class="pl-k">=</span><span class="pl-c1">7</span> (<span class="pl-c1">we</span><span class="pl-s"><span class="pl-pds">'</span>re not changing the value of a number when we change a! b still points to the object "5")</span>
<span class="pl-s"></span>
<span class="pl-s">a="a string"</span>
<span class="pl-s">b=a</span>
<span class="pl-s">  -&gt; a="a string", b="a string" (both variables are references to same string object)</span>
<span class="pl-s"></span>
<span class="pl-s">a="another string"</span>
<span class="pl-s">  -&gt; a="another string", b="a string"</span>
<span class="pl-s"></span>
<span class="pl-s">a = { key1=2, key2=4, key3="hello" }</span>
<span class="pl-s">b = a</span>
<span class="pl-s">  -&gt; b &amp; a refer to same object</span>
<span class="pl-s"></span>
<span class="pl-s">a.key1 = "new value"</span>
<span class="pl-s">  -&gt; b.key1 = "new value"</span></pre></div>

<p>When using things like function declarations and for loops, bear in mind that you are assigning by reference still and the parameters in those are all new <em>local</em> variables pointing to some object.
So "v" in "for k,v in pairs(myTable)" (see for loops below) is just a new reference to the object myTable[k] points to. Doing v=newValue wont change the object in the table (myTable[k] will still return the old value), but both v &amp; myTable[k] will return a pointer to the same object.</p>

<p>However, for tables, you can change the values <em>inside</em> a table since they are also references:</p>

<div class="highlight highlight-lua"><pre>a <span class="pl-k">=</span> {one<span class="pl-k">=</span><span class="pl-c1">1</span>, two<span class="pl-k">=</span><span class="pl-c1">2</span>, three<span class="pl-k">=</span><span class="pl-c1">3</span>}
b <span class="pl-k">=</span> a
b.<span class="pl-smi">one</span><span class="pl-k">=</span><span class="pl-c1">7</span>
  <span class="pl-k">-&gt;</span> a.<span class="pl-smi">one</span> <span class="pl-k">=</span> <span class="pl-c1">7</span> (because we have accessed <span class="pl-c1">the</span> <span class="pl-s"><span class="pl-pds">"</span>one<span class="pl-pds">"</span></span> variable <span class="pl-k">and</span> made it point to a new object)</pre></div>

<h2>
<a id="default-parameters-for-functions" class="anchor" href="#default-parameters-for-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Default parameters for functions</h2>

<p>You can pass fewer parameters to a function than it expects, in which case the un-set ones ones will just be nil. You can use this to implement default parameters, but only for values at the end of the list.</p>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>myFunction <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">v1,v2,v3,v4,v5</span>)
    v4 <span class="pl-k">=</span> v4 <span class="pl-k">or</span> <span class="pl-c1">100</span> <span class="pl-c">--default to 100 if nil</span>
    v5 <span class="pl-k">=</span> v5 <span class="pl-k">or</span> <span class="pl-s"><span class="pl-pds">"</span>something<span class="pl-pds">"</span></span>
    <span class="pl-c1">...</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="variable-scope-local-vs-global" class="anchor" href="#variable-scope-local-vs-global" aria-hidden="true"><span class="octicon octicon-link"></span></a>Variable Scope (local vs global)</h2>

<ul>
<li>By default, all variables are global! This is unusual if you're coming from C, Python, etc.</li>
<li>If you have two (global) variables of the same name in different functions, they will point to the same object.</li>
<li>You have to explicitly use the "local" keyword to declare a variable local.</li>
</ul>

<p>This is a typical place to create buggy code! Bear local vs global and code order in mind if you get errors like "value is nil" or you expect an event function to be called and nothing happens.</p>

<p>A common error I've seen is having a local-declared Quick scene object and having a global function for that object, but the function is declared first so Lua thinks the local object is different to the global similarly-named one...</p>

<p>Example:</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span> <span class="pl-en">myScene:</span><span class="pl-en">setUp</span>(<span class="pl-smi">event</span>)
    <span class="pl-c1">...</span>
<span class="pl-k">end</span>

<span class="pl-k">local</span> myScene <span class="pl-k">=</span> director:<span class="pl-c1">createScene</span>() <span class="pl-c">-- myScene here is NOT the same "myScene" as the one above! This is a new local object!</span></pre></div>

<h2>
<a id="destruction-and-garbage-collection" class="anchor" href="#destruction-and-garbage-collection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Destruction and garbage collection</h2>

<ul>
<li>Lua has no explicit destructor for objects.</li>
<li>The "nil" operator is similar to null in other languages.</li>
<li>Lua garbage-collects objects when there are no longer any active references to them.</li>
<li>To make sure there are no references to an object, set all variables that pointed to the object to be nil.</li>
<li>Lua uses incremental mark and sweep garbage collection.</li>
<li>By default, garbage collection runs at some interval which is not opaque to the user.</li>
</ul>

<p>Background reading:</p>

<ul>
<li>Intro to GC: <a href="http://www.lua.org/manual/5.1/manual.html#2.10">http://www.lua.org/manual/5.1/manual.html#2.10</a>
</li>
</ul>

<h2>
<a id="for-loops" class="anchor" href="#for-loops" aria-hidden="true"><span class="octicon octicon-link"></span></a>For Loops</h2>

<p>Lua provides 3 useful types of for loop:</p>

<ul>
<li>numeric - like a C for loop</li>
<li>pairs - for looping through an arbitrary table</li>
<li>ipairs - for looping through an "array" style table (see further down)</li>
</ul>

<h3>
<a id="numeric" class="anchor" href="#numeric" aria-hidden="true"><span class="octicon octicon-link"></span></a>Numeric:</h3>

<div class="highlight highlight-lua"><pre><span class="pl-k">for</span> var<span class="pl-k">=</span>exp1, exp2, exp3
    <span class="pl-k">do</span> something
<span class="pl-k">end</span></pre></div>

<ul>
<li>var is a local variable that only exists in the loop.</li>
<li>var starts at exp1, increments by exp3, loop ends when var &gt; exp2</li>
<li>exp1/2/3 must all be integers.</li>
<li>exp 3 is optional; defaults to 1.</li>
<li>Don't change var during the loop! Behaviour is unpredictable.</li>
<li>All three expressions are evaluated once, before the loop starts.</li>
</ul>

<p>Example:</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">for</span> n<span class="pl-k">=</span><span class="pl-c1">5</span>, <span class="pl-c1">math.min</span>(somevalue, <span class="pl-c1">0</span>), <span class="pl-k">-</span><span class="pl-c1">1</span> <span class="pl-k">do</span>
    <span class="pl-c1">print</span>(n) <span class="pl-c">--loop will run 5 times, math.min is called once</span>
<span class="pl-k">end</span></pre></div>

<h3>
<a id="pairs-generic-for-loop" class="anchor" href="#pairs-generic-for-loop" aria-hidden="true"><span class="octicon octicon-link"></span></a>pairs (generic for loop):</h3>

<div class="highlight highlight-lua"><pre><span class="pl-k">for</span> key,value <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(myTable)
    <span class="pl-k">do</span> something
<span class="pl-k">end</span></pre></div>

<ul>
<li>As above, variables are local to the loop and pairs is only run once</li>
<li>"value" is optional (use "for key in pairs(..." if you only care about the key)</li>
<li>The loop may go through keys in any arbitrary order. If your keys are 1,2,3,4, etc. they may not be accessed in that order!</li>
<li>Use myTable.key= to change the table, not value= (see below)</li>
</ul>

<h3>
<a id="ipairs" class="anchor" href="#ipairs" aria-hidden="true"><span class="octicon octicon-link"></span></a>ipairs:</h3>

<div class="highlight highlight-lua"><pre><span class="pl-k">for</span> key,value <span class="pl-k">in</span> <span class="pl-c1">ipairs</span>(myArray)
    <span class="pl-k">do</span> something
<span class="pl-k">end</span></pre></div>

<ul>
<li>As above but designed for tables that are "arrays" (keys are ordered integers starting at 1 - see below).</li>
<li>The loop goes from key=1, in order 2,3,4,etc till the last key that is not nil.</li>
</ul>

<p>You can break out of a for loop with the "break" keyword. Sadly there is no "continue" keyword in Lua.</p>

<h2>
<a id="tables-as-arrays" class="anchor" href="#tables-as-arrays" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tables as "arrays"</h2>

<p>Lua tables can be treated as arrays if the keys are all contiguous integers, starting from 1.</p>

<ul>
<li>Lua arrays start at 1 not zero!</li>
<li>You can initialise an array easily by not specifying keys, as in our earlier example:</li>
</ul>

<div class="highlight highlight-lua"><pre>mytable <span class="pl-k">=</span> {<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>value two<span class="pl-pds">"</span></span>, <span class="pl-c1">7</span>, <span class="pl-c1">5</span>, <span class="pl-s"><span class="pl-pds">"</span>another value<span class="pl-pds">"</span></span>}</pre></div>

<ul>
<li>Get the length of an array using table.getn(myTable). NB: "table" is a global object with various helper functions for other tables</li>
<li>The length of an array is defined as the last integer index, starting at 1, which does not have a value of nil.</li>
<li>Therefore, if you set a value in the middle of the array to nil then the rest of the array is then ignored in subsequent for ipairs() loops and table.getn() becomes unpredictable!</li>
</ul>

<p>Changing arrays:</p>

<ul>
<li>Arrays are dynamic (as they are tables) so you can add and remove values.</li>
<li>Add to an array using table.insert(myTable, value, )</li>
<li>Remove from an array using table.remove(myTable, )</li>
<li>Using .remove makes the table automatically fill the hole by moving other values down one index. Using myTable[index] = nil will NOT make the table re-size (actually it may depending on Lua implementation but it's not guaranteed so don't do it!).</li>
<li>Warning! The value returned by table.getn() is updated when you do inserts, but not removes!</li>
<li>If you set the LAST element to nil, then the array WILL "shrink" inside for ipairs() loops, but the behaviour of table.getn() isn't guaranteed.</li>
</ul>

<p>Sounds bug-friendly, right? It's probably safer to track dynamic array sizes yourself with a custom variable than to use table.getn().</p>

<p>If you are adding and removing a lot of values in loops and don't care about the index value being a list of integers, I'd recommend just using a table with unique IDs as keys. That means you can add and remove from all over your code without fear of bugs.</p>

<h2>
<a id="tables-as-classes-and-the-hidden-self-parameter" class="anchor" href="#tables-as-classes-and-the-hidden-self-parameter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tables as "classes" and the hidden "self" parameter</h2>

<p>Lua functions can be passed an implicit "self" reference by declaring functions using the ":" operator as opposed to "."</p>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>Simple <span class="pl-k">function</span>:
myObject <span class="pl-k">=</span> {}
myObject.<span class="pl-smi">name</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bob<span class="pl-pds">"</span></span>
myObject.<span class="pl-smi">myFunction</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>)
    <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>value<span class="pl-pds">"</span></span>)
<span class="pl-k">end</span>

myObject.<span class="pl-c1">myFunction</span>(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>)
<span class="pl-s"><span class="pl-pds">"</span>:<span class="pl-pds">"</span></span> version:
myObject <span class="pl-k">=</span> {}
myObject.<span class="pl-smi">name</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>bob<span class="pl-pds">"</span></span>
myObject:<span class="pl-smi">myFunction</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">value</span>)
    <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>value, my name is <span class="pl-pds">"</span></span> <span class="pl-k">..</span> <span class="pl-v">self</span>.<span class="pl-smi">name</span>) <span class="pl-c">-- we can access the table that owns this function using "self"</span>
<span class="pl-k">end</span>

myObject:<span class="pl-c1">myFunction</span>(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>) <span class="pl-c">-- now prints "hello, my name is bob"</span></pre></div>

<p>This is used a lot in Marmalade Quick, e.g. the event functions for scenes.</p>

<p>We can take advantage of this to create "classes" and do proper Object-Oriented (OO) coding. This is pretty fundamental if you want to have dynamically-created objects and to get access to objects from events. Note that there is no actual Lua concept of a "class", we are inventing it here!</p>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>MyClass <span class="pl-k">=</span> {} <span class="pl-c">--declare a global table that will "create" objects of this "class" for us</span>
MyClass.<span class="pl-smi">__index</span> <span class="pl-k">=</span> MyClass <span class="pl-c">-- .__index uses Lua's "metatable" feature to allow one table to use functions and values from another</span>
<span class="pl-c">-- a global function to create objects (tables) that all have the values and classes of MyClass</span>
<span class="pl-k">function</span> <span class="pl-en">MyClass.</span><span class="pl-en">Create</span>(<span class="pl-smi">someInitialiserValue, anotherInitialiser</span>)
    <span class="pl-k">local</span> myObject <span class="pl-k">=</span> {} <span class="pl-c">-- create object</span>
    <span class="pl-c1">setmetatable</span>(myObject,MyClass) <span class="pl-c">-- give access to MyClass members</span>
    myObject.<span class="pl-smi">val1</span> <span class="pl-k">=</span> someInitialiserValue
    myObject.<span class="pl-smi">val2</span> <span class="pl-k">=</span> anotherInitialiser
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">MyClass:</span><span class="pl-en">PrintSomeValueAndVal1</span>(<span class="pl-smi">someValue</span>)
    <span class="pl-c1">print</span>(someValue)
    <span class="pl-v">self</span>:<span class="pl-c1">PrintVal1</span>()
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">MyClass:</span><span class="pl-en">PrintVal1</span>()
    <span class="pl-c1">print</span>(<span class="pl-v">self</span>.<span class="pl-smi">val1</span>)
<span class="pl-k">end</span>

someObject <span class="pl-k">=</span> MyClass.<span class="pl-c1">Create</span>(<span class="pl-c1">4</span>,<span class="pl-c1">8</span>)
someObject:<span class="pl-c1">PrintSomeValueAndVal1</span>(<span class="pl-c1">27</span>)

secondObject <span class="pl-k">=</span> MyClass.<span class="pl-c1">Create</span>(<span class="pl-c1">5</span>,<span class="pl-c1">1</span>)
<span class="pl-c1">print</span>(secondObject.<span class="pl-smi">val2</span>) <span class="pl-c">-- can access members still like any table</span></pre></div>

<p>NB: you can still call functions without the ":", in which case they expect self to be passed! This can lead to bugs, e.g. someObject.PrintSomeValueAndVal1(27) would result in self=27 and someValue=nil! Be aware of this generally when using . vs : with Quick's API. Getting an error with param = nil when you know you have passed the values expected is a typical indication of using . instead of :</p>

<h2>
<a id="including-code-from-other-files" class="anchor" href="#including-code-from-other-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>Including code from other files</h2>

<p>Use "doFile" to load and execute another file.</p>

<div class="highlight highlight-lua"><pre><span class="pl-c1">doFile</span>(<span class="pl-s"><span class="pl-pds">"</span>path/to/otherfile.lua<span class="pl-pds">"</span></span>)</pre></div>

<p>This is the same as just substituting the doFile statement with the contents of the other file. So, if otherfile has a "return" statement at the end, you can do:</p>

<div class="highlight highlight-lua"><pre>myValue <span class="pl-k">=</span> <span class="pl-c1">doFile</span>(<span class="pl-s"><span class="pl-pds">"</span>path/to/otherfile.lua<span class="pl-pds">"</span></span>)</pre></div>

<p>You can also use "require", which does the same thing but searches a list of paths and won't re-load code that has already been included with another require call. That makes it more like normal "library loading" and generally a better idea for large projects. See <a href="http://www.lua.org/pil/8.1.html">http://www.lua.org/pil/8.1.html</a></p>

<h2>
<a id="some-thoughts-on-lua-as-a-noob" class="anchor" href="#some-thoughts-on-lua-as-a-noob" aria-hidden="true"><span class="octicon octicon-link"></span></a>Some Thoughts on Lua as a Noob</h2>

<p>As a big fan of Python (for non-gaming), I find Lua a little frustrating in that the syntax is so small. No +=, no built-in classes, no default parameters... Lua is not meant for throwing together a complex bit of hard-core data processing in a few lines! As a C person, I also wish I could control garbage collection better. However the "every variable is a reference; everything object is a string/number/function/table" simplicity of Lua is a breath of fresh air in terms of knowing exactly what's going on without having to understand any Lua internals at all. Once you get that and how to do pseudo-classes, you pretty much know everything about Lua! It's very easy in something like Python to get lost building a pass-by-value monster chunk of data that kills all your RAM. Lua objects are super-easy to visualise and it's pretty easy to produce fast, efficient code.</p>

<p>Next time we'll be putting all that into practice building a real game. We'll see how Quick uses lua "classes" to implement it's "objects", "libraries" and "events" and how to best take advantage of Quick's node-based scene management.</p>

<h1>
<a id="building-a-marmalade-quick-game-pt-3-building-the-wrong-prototype" class="anchor" href="#building-a-marmalade-quick-game-pt-3-building-the-wrong-prototype" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a Marmalade Quick Game pt 3: Building the "Wrong" Prototype</h1>

<p>Having played around briefly with the Quick examples, I decided to go straight for building a game and to figure out the rest on the way. I wanted something with some simple controls and screens that I could build on and polish later. I recently unearthed a very old nameless pong clone that I'd built in an old visual game maker app a very long time ago. It's basically pong with weapons, but backwards as you have to avoid the balls. I've decided to resurrect and improve my little reverse-pong game, now official know as "Wrong" (Weaponified Reverse pONG!) I'll be re-building Wrong from scratch and adding new features as I go. These blog posts will include code snippets that you can steal and learn from. At the end I'll upload to iOS, Android, BlackBerry and Windows Phone 8 stores, plus put the full source code up on GitHub.</p>

<p>The screen below gives you and idea of the original looked:
<img src="http://i1353.photobucket.com/albums/q663/GazDeaves/protowrong_zps20a235a9.png" alt="original game screenshot"></p>

<p>Be warned that the final version is not gonna look quite like that!</p>

<p>To implement Wrong, we basically need:</p>

<ul>
<li>a background image</li>
<li>objects for the player "sleds"</li>
<li>ball objects</li>
<li>counters for health</li>
<li>counters, icons and objects for all the weapons</li>
<li>controls to move the players</li>
<li>logic for ball and weapon movement, bouncing and collision detection for hitting players</li>
<li>health, weapon firing and power-up logic</li>
<li>lots of simple animations for impacts etc.</li>
<li>menus and battle setup logic</li>
</ul>

<p>Importantly, we also need to put some thought into adapting the game for modern devices:</p>

<ul>
<li>The original version was fixed at 640x480 fullscreen for PC; the new one needs to run on phones and tablets in all sorts of resolutions and aspect ratios (just take a look at <a href="http://en.wikipedia.org/wiki/Comparison_of_Android_devices">http://en.wikipedia.org/wiki/Comparison_of_Android_devices</a> !!).</li>
<li>The original was 2 player only, on a single device; the new one probably ought to have some one player and networked play options (two players on one phone? Not likely!).</li>
<li>The original was controlled by each player having keyboard keys for up, down, fire and a separate key to select each weapon; the new one will need to support touch-only interfaces.</li>
<li>The original graphics are nice in an amateur pixel art kind of way; I want something a little more polished and memorable.</li>
</ul>

<p>Initially, I just needed a prototype and to keep it simple, so I decided to skip weapons and controls for player 2, plus stick with single-touch controls and keep the menu super-minimal. This will be a learning experience; we want to get something off the ground, see what Quick is capable of and then make some design decisions based on that before doing any serious coding.
I ripped the graphics files out of the original to get some art to work with, though at the prototype stage I'll be using some vectors to avoid wasting time polishing bitmaps that will probably not make it into the final build anyway. I'm also starting with little in the way of animation, but will build on that later.</p>

<h2>
<a id="creating-scenes-and-a-background" class="anchor" href="#creating-scenes-and-a-background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating scenes and a background</h2>

<p>I'm including all the source and steps for the prototype build. Feel free to follow along.</p>

<p>Starting a new project:
1. Open /quick/tool/quickLaunchPad.exe/app
1. Create a New Project
1. Click "Open Folder" to get to the project source
1. All assets including the Lua source live in "resources" by default, so open that folder.</p>

<p>NB: by default quick will package <em>all</em> files in that folder into your app when you deploy to device. Exisiting Marmalade users will notice that it's included in the project's "assets" block. If you're new to Marmalade we'll cover that stuff at a later date.</p>

<p>I'm going to use backdrop.png (ripped from my old game) so I've put that in resources/textures. To get started, edit main.lua (I recommend Notepad++ or the ZeroBrane Lua editor). This is the default main code file for Marmalade Quick.</p>

<div class="highlight highlight-lua"><pre><span class="pl-c">-- app globals</span>
appWidth <span class="pl-k">=</span> director.<span class="pl-smi">displayWidth</span>
appHeight <span class="pl-k">=</span> director.<span class="pl-smi">displayHeight</span>
battleCount <span class="pl-k">=</span> <span class="pl-c1">0</span>

<span class="pl-c">-- Main menu --------------------------------------------------------------------</span>

sceneMainMenu <span class="pl-k">=</span> director:<span class="pl-c1">createScene</span>() <span class="pl-c">--this becomes the current scene automatically</span>

<span class="pl-k">function</span> <span class="pl-en">sceneMainMenu:</span><span class="pl-en">setUp</span>(<span class="pl-smi">event</span>) <span class="pl-c">-- declare a member functions of the scene object</span>
    dbg.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>sceneMainMenu:setUp<span class="pl-pds">"</span></span>)

    <span class="pl-c">-- adding a label as member of the scene itself allows us to manage it easily</span>
    <span class="pl-v">self</span>.<span class="pl-smi">label</span> <span class="pl-k">=</span> director:<span class="pl-c1">createLabel</span>({x<span class="pl-k">=</span>appWidth<span class="pl-k">/</span><span class="pl-c1">2</span>, y<span class="pl-k">=</span>appHeight<span class="pl-k">/</span><span class="pl-c1">2</span>, text<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>Main Menu<span class="pl-pds">"</span></span>})
    <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">x</span> <span class="pl-k">-</span> <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">xText</span><span class="pl-k">/</span><span class="pl-c1">2</span>
<span class="pl-k">end</span>
<span class="pl-k">function</span> <span class="pl-en">sceneMainMenu:</span><span class="pl-en">tearDown</span>(<span class="pl-smi">event</span>)
    dbg.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>sceneMainMenu:tearDown<span class="pl-pds">"</span></span>)
    <span class="pl-v">self</span>.<span class="pl-smi">label</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span> <span class="pl-c">-- good practice to nil unused objects</span>
<span class="pl-k">end</span>

sceneMainMenu:<span class="pl-c1">addEventListener</span>({<span class="pl-s"><span class="pl-pds">"</span>setUp<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>tearDown<span class="pl-pds">"</span></span>}, sceneMainMenu)

<span class="pl-c">-- battle screen -------------------------------------------------------</span>

sceneBattle <span class="pl-k">=</span> director:<span class="pl-c1">createScene</span>()
<span class="pl-k">function</span> <span class="pl-en">sceneBattle:</span><span class="pl-en">setUp</span>(<span class="pl-smi">event</span>)
    dbg.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>sceneBattle:setUp<span class="pl-pds">"</span></span>)

    <span class="pl-c">-- director:create makes the current scene the parent node. The scene keeps a reference to its children.</span>
    <span class="pl-c">-- director's coordinates (x=,y=) are relative to the parent, i.e. the scene in this case which always</span>
    <span class="pl-c">-- has (0,0) at the bottom left of the screen</span>
    background <span class="pl-k">=</span> director:<span class="pl-c1">createSprite</span>(<span class="pl-c1">0</span>, <span class="pl-c1">0</span>, <span class="pl-s"><span class="pl-pds">"</span>textures/backdrop.png<span class="pl-pds">"</span></span>) <span class="pl-c">--file paths are relative to the root of the "resources" folder</span>

    <span class="pl-c">-- debug label to check we're in right scene!</span>
    <span class="pl-v">self</span>.<span class="pl-smi">label</span> <span class="pl-k">=</span> director:<span class="pl-c1">createLabel</span>({x<span class="pl-k">=</span>appWidth<span class="pl-k">/</span><span class="pl-c1">2</span>, y<span class="pl-k">=</span><span class="pl-c1">30</span>, text<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>Battle <span class="pl-pds">"</span></span> <span class="pl-k">..</span> battleCount})
    <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">x</span> <span class="pl-k">-</span> <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">xText</span><span class="pl-k">/</span><span class="pl-c1">2</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">sceneBattle:</span><span class="pl-en">tearDown</span>(<span class="pl-smi">event</span>)
    dbg.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>sceneBattle:tearDown<span class="pl-pds">"</span></span>)
    <span class="pl-v">self</span>.<span class="pl-smi">label</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span>

    background:<span class="pl-c1">removeFromParent</span>()
    background <span class="pl-k">=</span> <span class="pl-c1">nil</span>

    dbg.<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>sceneBattle:tearDown done<span class="pl-pds">"</span></span>)
<span class="pl-k">end</span>
sceneBattle:<span class="pl-c1">addEventListener</span>({<span class="pl-s"><span class="pl-pds">"</span>setUp<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>tearDown<span class="pl-pds">"</span></span>}, sceneBattle)

<span class="pl-c">------------------------------------------------------------------------------------</span>

director:<span class="pl-c1">moveToScene</span>(sceneMainMenu) <span class="pl-c">-- start game with instantaneous change to main menu (last scene created is current)</span>

<span class="pl-c">-- simple global event to change current scene on touch</span>
<span class="pl-k">local</span> touch <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">event</span>)
    <span class="pl-k">if</span> event.<span class="pl-smi">phase</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>began<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        <span class="pl-k">if</span> director:<span class="pl-c1">getCurrentScene</span>() <span class="pl-k">==</span> sceneMainMenu <span class="pl-k">then</span>
            battleCount <span class="pl-k">=</span> battleCount<span class="pl-k">+</span><span class="pl-c1">1</span>
            director:<span class="pl-c1">moveToScene</span>(sceneBattle, {transitionType<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>slideInL<span class="pl-pds">"</span></span>, transitionTime<span class="pl-k">=</span><span class="pl-c1">0.5</span>})
        <span class="pl-k">else</span>
            director:<span class="pl-c1">moveToScene</span>(sceneMainMenu, {transitionType<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>slideInL<span class="pl-pds">"</span></span>, transitionTime<span class="pl-k">=</span><span class="pl-c1">0.5</span>})
        <span class="pl-k">end</span>
    <span class="pl-k">end</span>
<span class="pl-k">end</span>
system:<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">"</span>touch<span class="pl-pds">"</span></span>, touch)</pre></div>

<p>A couple of notes:</p>

<ul>
<li>I'm using global variables for the scene to keep it simple</li>
<li>setUp and tearDown are predefined valid event names for scenes</li>
<li>By declaring them as member variables using the ":" operator, we get an automatic "self" reference to the scene itself from within the function.</li>
<li>addEventListener registers a list of members (i.e. functions by name) for the given table (i.e. the scene)</li>
<li>Let's run the code. On the Test tab in the launchpad, make sure Debug mode is selected and hit the Launch button. You should get an assert message box pop up when clickting to change the scene. It's fairly obviously pointing to a missing texture file. If you hit continue or ignore, the app will eventually display an error message and quit. This is because the lack of texture is an unrecoverable error. Quick looks for assets in the "resources" folder, so save the image below to resources/textures/backdrop.png.</li>
</ul>

<p><img src="https://f.cloud.github.com/assets/1637721/623109/78a18eae-cf59-11e2-854b-122e04c83c13.png" alt="stars backdrop image"></p>

<h2>
<a id="debug-vs-release" class="anchor" href="#debug-vs-release" aria-hidden="true"><span class="octicon octicon-link"></span></a>Debug vs Release</h2>

<p>Try running again with Build Mode set to Release in the Launchpad. Note that in release mode you only get the error message and no asserts. But you still get a stack trace (in orange) in the console view.</p>

<p>Everything should work with the texture added, but the screen size probably doesn't match the background size (depending on if you've been fiddling with the Simulator previously...) Go to Simulator &gt; Configuration &gt; Surface and set the width and height to 640x480 to match our background. Restart the app with Ctrl-T. Ctr-T is needed to restart the whole app - rather than Ctr-R, which just reloads the lua code - since Quick has internally cached the screen size on startup.</p>

<p>We've got a huge image as our background and it's mostly black - a bit of waste of resources. Why not have a randomly generated star-field instead! In setUp, replace the background creation with:</p>

<div class="highlight highlight-lua"><pre>    background <span class="pl-k">=</span> director:<span class="pl-c1">createRectangle</span>({
        x<span class="pl-k">=</span><span class="pl-c1">0</span>, y<span class="pl-k">=</span><span class="pl-c1">0</span>,
        w<span class="pl-k">=</span>appWidth, h<span class="pl-k">=</span>appHeight,
        strokeWidth<span class="pl-k">=</span><span class="pl-c1">0</span>,
        color<span class="pl-k">=</span>color.<span class="pl-smi">black</span>, alpha<span class="pl-k">=</span><span class="pl-c1">1.0</span>})

    <span class="pl-c1">math.randomseed</span>(<span class="pl-c1">os.time</span>())

    <span class="pl-k">for</span> n<span class="pl-k">=</span><span class="pl-c1">0</span>, <span class="pl-c1">100</span>, <span class="pl-c1">1</span> <span class="pl-k">do</span>
        <span class="pl-c">-- star is local to a single loop call, but on each call a new vector object is created</span>
        <span class="pl-c">-- Without "local", this would still work, but we'd have to do star=nil at the end or</span>
        <span class="pl-c">-- the final object would still be referenced at the end</span>
        <span class="pl-k">local</span> star <span class="pl-k">=</span> director:<span class="pl-c1">createLines</span>({x<span class="pl-k">=</span><span class="pl-c1">math.random</span>(<span class="pl-c1">0</span>, appWidth), y<span class="pl-k">=</span><span class="pl-c1">math.random</span>(<span class="pl-c1">0</span>, appHeight), coords<span class="pl-k">=</span>{<span class="pl-c1">0</span>,<span class="pl-c1">0</span>, <span class="pl-c1">1</span>,<span class="pl-c1">1</span>}, strokeWidth <span class="pl-k">=</span> <span class="pl-c1">1</span>})

        <span class="pl-c">-- set start colour: get a random white value then allow some variance in each channel for off-white result</span>
        <span class="pl-k">local</span> brightness <span class="pl-k">=</span> <span class="pl-c1">math.random</span>(<span class="pl-c1">20</span>, <span class="pl-c1">127</span>)
        star.<span class="pl-smi">strokeColor</span> <span class="pl-k">=</span> {<span class="pl-c1">math.random</span>(brightness<span class="pl-k">-</span><span class="pl-c1">20</span>, brightness), <span class="pl-c1">math.random</span>(brightness<span class="pl-k">-</span><span class="pl-c1">5</span>, brightness), <span class="pl-c1">math.random</span>(brightness<span class="pl-k">-</span><span class="pl-c1">20</span>, brightness)}

        background:<span class="pl-c1">addChild</span>(star)

        <span class="pl-c">-- NB: background.children is now a table with references to the star objects.</span>
        <span class="pl-c">-- star coords are now relative to background. We can now easily move them all by moving the background</span>
    <span class="pl-k">end</span></pre></div>

<p>And in tearDown, before background:removeFromParent, add:</p>

<div class="highlight highlight-lua"><pre>    <span class="pl-k">for</span> k,v <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(background.<span class="pl-smi">children</span>) <span class="pl-k">do</span>
        v:<span class="pl-c1">removeFromParent</span>() <span class="pl-c">-- take object out of the scene, no references left so lua will garbage collect stars</span>
    <span class="pl-k">end</span></pre></div>

<h2>
<a id="quick-tip" class="anchor" href="#quick-tip" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Tip</h2>

<p>When a Lua error occurs, the app will output info to the console but will usually continue running unless a serious error is encountered in the internal C++ code (usually due to your bad Lua code :p). This can make finding the error in the console awkward as trace will keep running way past the error itself.</p>

<p>A good solution is to add the following to your resources/app.icf file:</p>

<pre><code>[s3e] WindowSuspendOnFocusLoss=1
</code></pre>

<p>For those new to Marmalade, app.icf is a standard Marmalade config file for setting runtime options. This option will suspend the app on Desktop when the window is out of focus (device builds are automatically paused on focus loss). With this set, you can just click on the trace console window to make the app window, and therefore all tracing, pause.</p>

<p>It's always worth scrolling back through the trace if it doesn't appear to tell you a lot. A Lua error may have occured long before you notice any side-effects on screen.</p>

<h2>
<a id="notes-on-updates-from-beta-version-to-v10-release" class="anchor" href="#notes-on-updates-from-beta-version-to-v10-release" aria-hidden="true"><span class="octicon octicon-link"></span></a>Notes on updates from Beta version to v1.0 release</h2>

<ul>
<li>myNode:destroy() was listed in the beta docs... this is an error as it doesn't actually exist! We "destroy" a Quick node by doing myNode:removeFromParent() then myNode = nil (see the background object in the code).</li>
<li>myNode.children is a table with references to each object added with myNode:addChild() - this is really useful but was not documented in the beta.</li>
<li>Rectangles and circles now have default anchor points of (0,0) like any other node. In the beta, they had undocumented (0.5,0.5) anchors so they were drawn centred on the x &amp; y position but this was considered confusing: inconsistent with other shapes; children positions were non-intuitive as they ignore the anchor offset.</li>
</ul>

<h2>
<a id="adding-balls-and-timers" class="anchor" href="#adding-balls-and-timers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding balls and timers</h2>

<p>First, we'll define some useful globals for managing the scene:</p>

<div class="highlight highlight-lua"><pre>minX <span class="pl-k">=</span> <span class="pl-k">-</span>appWidth<span class="pl-k">/</span><span class="pl-c1">2</span>
maxX <span class="pl-k">=</span> appWidth<span class="pl-k">/</span><span class="pl-c1">2</span>
minY <span class="pl-k">=</span> <span class="pl-k">-</span>appHeight<span class="pl-k">/</span><span class="pl-c1">2</span>
maxY <span class="pl-k">=</span> appHeight<span class="pl-k">/</span><span class="pl-c1">2</span>
ballRadius <span class="pl-k">=</span> <span class="pl-c1">8</span></pre></div>

<p>In SceneBattle:SetUp(), we set up timers to add more balls. We also create an "origin" node object at screen center so that other objects can be positioned relative to this point by making them its children.</p>

<div class="highlight highlight-lua"><pre>    ballSpeed <span class="pl-k">=</span> <span class="pl-c1">1</span>
    ballCreateFlag <span class="pl-k">=</span> <span class="pl-c1">10</span> <span class="pl-c">-- queues up balls to add at any time</span>
    ballTimer <span class="pl-k">=</span> system:<span class="pl-c1">addTimer</span>(addNewBall, <span class="pl-c1">10</span>, <span class="pl-c1">0</span>)
    ballReplaceTimer <span class="pl-k">=</span> system:<span class="pl-c1">addTimer</span>(replenishBalls, <span class="pl-c1">0.2</span>, <span class="pl-c1">0</span>)
    origin <span class="pl-k">=</span> director:<span class="pl-c1">createNode</span>({x<span class="pl-k">=</span>appWidth<span class="pl-k">/</span><span class="pl-c1">2</span>, y<span class="pl-k">=</span>appHeight<span class="pl-k">/</span><span class="pl-c1">2</span>})</pre></div>

<p>Lets create a ball object (using the "class" method with metatable lookup). We'll manage ball movement ourselves as its so simple but can "upgrade" to Quick's built in physics (box2d) if needed.</p>

<div class="highlight highlight-lua"><pre>Collidable <span class="pl-k">=</span> {}
Collidable.<span class="pl-smi">__index</span> <span class="pl-k">=</span> Collidable

collidables <span class="pl-k">=</span> {}

<span class="pl-k">function</span> <span class="pl-en">Collidable.</span><span class="pl-en">Create</span>(<span class="pl-smi">objType, xPos, yPos, startVector</span>)
    <span class="pl-k">local</span> collidable <span class="pl-k">=</span> {}                <span class="pl-c">-- the new object</span>
    <span class="pl-c1">setmetatable</span>(collidable,Collidable)  <span class="pl-c">-- make Player handle lookup</span>

    <span class="pl-k">if</span> objType <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>expander<span class="pl-pds">"</span></span> <span class="pl-k">then</span> <span class="pl-c">--extend to ues for weapons</span>
        <span class="pl-c">-- do </span>
    <span class="pl-k">elseif</span> objType <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>heatseeker<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        <span class="pl-c">-- do</span>
        <span class="pl-c">-- etc</span>
    <span class="pl-k">else</span>
        collidable <span class="pl-k">=</span> director:<span class="pl-c1">createSprite</span>({
            x<span class="pl-k">=</span>xPos,
            y<span class="pl-k">=</span>yPos,
            xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>,
            yAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>,
            source<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>textures/wrongball.png<span class="pl-pds">"</span></span>})

        tween:<span class="pl-c1">from</span>(collidable, {xScale<span class="pl-k">=</span><span class="pl-c1">0</span>, yScale<span class="pl-k">=</span><span class="pl-c1">0</span>, time<span class="pl-k">=</span><span class="pl-c1">0.5</span>}) <span class="pl-c">--simple fade in anim</span>
        <span class="pl-k">end</span>
    collidable.<span class="pl-smi">vec</span> <span class="pl-k">=</span> startVector
    collidable.<span class="pl-smi">objType</span> <span class="pl-k">=</span> objType

    origin:<span class="pl-c1">addChild</span>(collidable)
    collidables[collidable.<span class="pl-smi">name</span>] <span class="pl-k">=</span> collidable <span class="pl-c">--node.name is a unique ID so we can track balls in the scene easily</span>
    <span class="pl-k">return</span> collidable
<span class="pl-k">end</span></pre></div>

<p>And finally implement the timer functions for adding new balls:</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span> <span class="pl-en">VectorFromAngle</span>(<span class="pl-smi">angle, size</span>)
    <span class="pl-k">return</span> {x <span class="pl-k">=</span> (<span class="pl-c1">math.sin</span>(angle) <span class="pl-k">*</span> size), y <span class="pl-k">=</span> (<span class="pl-c1">math.cos</span>(angle) <span class="pl-k">*</span> size)}
<span class="pl-k">end</span>

<span class="pl-k">local</span> addBall <span class="pl-k">=</span> <span class="pl-k">function</span>()
    <span class="pl-c">-- we push the ball straight to a global table in create so no need to get a ref here</span>
    Collidable.<span class="pl-c1">Create</span>(<span class="pl-s"><span class="pl-pds">"</span>ball<span class="pl-pds">"</span></span>, <span class="pl-c1">0</span>, <span class="pl-c1">0</span>, <span class="pl-c1">VectorFromAngle</span>(<span class="pl-c1">math.rad</span>(<span class="pl-c1">math.random</span>(<span class="pl-c1">0</span>,<span class="pl-c1">359</span>)), <span class="pl-c1">math.random</span>(ballSpeed,ballSpeed<span class="pl-k">+</span><span class="pl-c1">3</span>)))
<span class="pl-k">end</span>

<span class="pl-k">local</span> addNewBall <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">event</span>)
    ballSpeed <span class="pl-k">=</span> ballSpeed <span class="pl-k">+</span> <span class="pl-c1">1</span>
    <span class="pl-c1">addBall</span>()
<span class="pl-k">end</span>

<span class="pl-k">local</span> replenishBalls <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">event</span>)
    <span class="pl-k">if</span> ballCreateFlag <span class="pl-k">&gt;</span> <span class="pl-c1">0</span> <span class="pl-k">then</span>
        ballSpeed <span class="pl-k">=</span> ballSpeed <span class="pl-k">+</span> <span class="pl-c1">0.3</span>
        ballCreateFlag <span class="pl-k">=</span> ballCreateFlag <span class="pl-k">-</span><span class="pl-c1">1</span>
        <span class="pl-c1">addBall</span>()
    <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="adding-players-controls-and-health" class="anchor" href="#adding-players-controls-and-health" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adding players, controls and health</h2>

<p>We add a player class like the collidables. Note that we're doing cheap collision detecting so have hard coded some size values. There's also a simple text label for health and we jump straight back to the main menu on health hitting zero.</p>

<div class="highlight highlight-lua"><pre>Player <span class="pl-k">=</span> {}
Player.<span class="pl-smi">__index</span> <span class="pl-k">=</span> Player <span class="pl-c">-- meta table to implement a "class" in lua</span>

<span class="pl-k">function</span> <span class="pl-en">Player.</span><span class="pl-en">Create</span>(<span class="pl-smi">id, health</span>)
    <span class="pl-k">local</span> player <span class="pl-k">=</span> {}
    <span class="pl-c1">setmetatable</span>(player,Player)

    <span class="pl-c">-- initialize the object</span>
    player.<span class="pl-smi">id</span> <span class="pl-k">=</span> id <span class="pl-c">-- player is just a table and we're assigning key-value pairs to it</span>
    player.<span class="pl-smi">touch</span> <span class="pl-k">=</span> {}
    player.<span class="pl-smi">touch</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    player.<span class="pl-smi">touch</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    player.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
    player.<span class="pl-smi">moveWithFinger</span> <span class="pl-k">=</span> <span class="pl-c1">false</span>
    player.<span class="pl-smi">health</span> <span class="pl-k">=</span> health

    player.<span class="pl-smi">touchPosDiff</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    player.<span class="pl-smi">halfHeight</span> <span class="pl-k">=</span> <span class="pl-c1">21</span> <span class="pl-c">--for detecting collisions</span>
    player.<span class="pl-smi">sledColour</span> <span class="pl-k">=</span> <span class="pl-c1">nil</span>

    <span class="pl-c">-- Visual stuff</span>
    <span class="pl-c">-- Sleds are 8x42 with anchor at "front"</span>
    <span class="pl-c">-- y pos of sled used for movement</span>
    <span class="pl-k">local</span> mirrorX <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    <span class="pl-k">local</span> xPos <span class="pl-k">=</span> <span class="pl-c1">nil</span>

    <span class="pl-k">if</span> id <span class="pl-k">==</span> <span class="pl-c1">1</span> <span class="pl-k">then</span>
        mirrorX <span class="pl-k">=</span> <span class="pl-c1">1</span>
        player.<span class="pl-smi">sledColour</span> <span class="pl-k">=</span> color.<span class="pl-smi">fuchsia</span>
        xPos <span class="pl-k">=</span> <span class="pl-k">-</span>appWidth<span class="pl-k">/</span><span class="pl-c1">2</span> <span class="pl-k">+</span> <span class="pl-c1">20</span>
    <span class="pl-k">else</span>
        mirrorX <span class="pl-k">=</span> <span class="pl-k">-</span><span class="pl-c1">1</span>
        player.<span class="pl-smi">sledColour</span> <span class="pl-k">=</span> color.<span class="pl-smi">yellow</span>
        xPos <span class="pl-k">=</span> appWidth<span class="pl-k">/</span><span class="pl-c1">2</span> <span class="pl-k">-</span> <span class="pl-c1">20</span>
    <span class="pl-k">end</span>

    <span class="pl-c">-- for now, use cheap labels for health</span>
    player.<span class="pl-smi">label</span> <span class="pl-k">=</span> director:<span class="pl-c1">createLabel</span>({x<span class="pl-k">=</span><span class="pl-c1">20</span>, y<span class="pl-k">=</span>appHeight<span class="pl-k">-</span><span class="pl-c1">40</span>, text<span class="pl-k">=</span>health})
    player.<span class="pl-smi">label</span>.<span class="pl-smi">color</span> <span class="pl-k">=</span> player.<span class="pl-smi">sledColour</span>
    <span class="pl-k">if</span> id <span class="pl-k">==</span> <span class="pl-c1">2</span> <span class="pl-k">then</span> player.<span class="pl-smi">label</span>.<span class="pl-smi">x</span><span class="pl-k">=</span>appWidth<span class="pl-k">-</span><span class="pl-c1">40</span> <span class="pl-k">end</span>
    player.<span class="pl-smi">sled</span> <span class="pl-k">=</span> director:<span class="pl-c1">createSprite</span>({x<span class="pl-k">=</span>xPos, y<span class="pl-k">=</span><span class="pl-c1">0</span>, xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>, yAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>, source<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>textures/sledp<span class="pl-pds">"</span></span> <span class="pl-k">..</span> id <span class="pl-k">..</span> <span class="pl-s"><span class="pl-pds">"</span>.png<span class="pl-pds">"</span></span>})

    <span class="pl-c">-- pre-calculate collision pos for balls to do super-cheap collision detection</span>
    player.<span class="pl-smi">collideX</span> <span class="pl-k">=</span> player.<span class="pl-smi">sled</span>.<span class="pl-smi">x</span> <span class="pl-k">+</span> mirrorX<span class="pl-k">*</span>ballRadius
    player.<span class="pl-smi">collideY</span> <span class="pl-k">=</span> player.<span class="pl-smi">halfHeight</span> <span class="pl-k">+</span> ballRadius <span class="pl-c">--relative to sled</span>

    origin:<span class="pl-c1">addChild</span>(player.<span class="pl-smi">sled</span>)
    <span class="pl-k">return</span> player
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">Player:</span><span class="pl-en">Destroy</span>()
    <span class="pl-v">self</span>.<span class="pl-smi">sled</span>:<span class="pl-c1">removeFromParent</span>()
    <span class="pl-v">self</span>.<span class="pl-smi">label</span>:<span class="pl-c1">removeFromParent</span>()
<span class="pl-k">end</span>

<span class="pl-c">-- some functions we'll add later</span>
<span class="pl-k">function</span> <span class="pl-en">Player:</span><span class="pl-en">AddAmmo</span>(<span class="pl-smi">amount</span>)
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">Player:</span><span class="pl-en">AddHealth</span>(<span class="pl-smi">amount</span>)
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">Player:</span><span class="pl-en">Fire</span>(<span class="pl-smi">weapon</span>)
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">Player:</span><span class="pl-en">TakeHit</span>() <span class="pl-c">-- simple "flash" anim</span>
    tween:<span class="pl-c1">to</span>(<span class="pl-v">self</span>.<span class="pl-smi">sled</span>, {alpha<span class="pl-k">=</span><span class="pl-c1">0.2</span>, time<span class="pl-k">=</span><span class="pl-c1">0.1</span>})
    tween:<span class="pl-c1">to</span>(<span class="pl-v">self</span>.<span class="pl-smi">sled</span>, {alpha<span class="pl-k">=</span><span class="pl-c1">1.0</span>, time<span class="pl-k">=</span><span class="pl-c1">0.1</span>, delay<span class="pl-k">=</span><span class="pl-c1">0.1</span>})
    <span class="pl-v">self</span>.<span class="pl-smi">health</span> <span class="pl-k">=</span> <span class="pl-v">self</span>.<span class="pl-smi">health</span> <span class="pl-k">-</span><span class="pl-c1">1</span>
    <span class="pl-k">if</span> <span class="pl-v">self</span>.<span class="pl-smi">health</span> <span class="pl-k">==</span> <span class="pl-c1">0</span> <span class="pl-k">then</span>
        director:<span class="pl-c1">moveToScene</span>(sceneMainMenu, {transitionType<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>slideInR<span class="pl-pds">"</span></span>, transitionTime<span class="pl-k">=</span><span class="pl-c1">0.5</span>})
    <span class="pl-k">end</span>

    <span class="pl-v">self</span>.<span class="pl-smi">label</span>.<span class="pl-smi">text</span> <span class="pl-k">=</span> <span class="pl-v">self</span>.<span class="pl-smi">health</span>
<span class="pl-k">end</span></pre></div>

<p>Back in our SceneBattler:SetUp event, we set up the players:</p>

<div class="highlight highlight-lua"><pre>    player1 <span class="pl-k">=</span> Player.<span class="pl-c1">Create</span>(<span class="pl-c1">1</span>, <span class="pl-c1">5</span>)
    player2 <span class="pl-k">=</span> Player.<span class="pl-c1">Create</span>(<span class="pl-c1">2</span>, <span class="pl-c1">5</span>)

    players <span class="pl-k">=</span> {}
    <span class="pl-c1">table.insert</span>(players, player1)
    <span class="pl-c1">table.insert</span>(players, player2)</pre></div>

<h2>
<a id="collisions-and-touch-control" class="anchor" href="#collisions-and-touch-control" aria-hidden="true"><span class="octicon octicon-link"></span></a>Collisions and Touch Control</h2>

<p>Finally, we add some touch controls for player one and simple collision testing. The touch events move the sled exactly with the finger, and then apply some decelerated velocity on release.</p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span> <span class="pl-en">sceneBattle:</span><span class="pl-en">touch</span>(<span class="pl-smi">event</span>)
    event.<span class="pl-smi">y</span> <span class="pl-k">=</span> event.<span class="pl-smi">y</span> <span class="pl-k">-</span> appHeight<span class="pl-k">/</span><span class="pl-c1">2</span> <span class="pl-c">--touch 0,0 always bottom left; align with our origin</span>

    <span class="pl-k">if</span> event.<span class="pl-smi">phase</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>began<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        player1.<span class="pl-smi">touch</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> event.<span class="pl-smi">x</span>
        player1.<span class="pl-smi">touch</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> event.<span class="pl-smi">y</span>
        player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
        player1.<span class="pl-smi">touchPosDiff</span> <span class="pl-k">=</span> event.<span class="pl-smi">y</span> <span class="pl-k">-</span> player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span>
    <span class="pl-k">end</span>

    <span class="pl-k">if</span> event.<span class="pl-smi">phase</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>ended<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        player1.<span class="pl-smi">moveWithFinger</span> <span class="pl-k">=</span> <span class="pl-c1">false</span>
    <span class="pl-k">end</span>

    <span class="pl-k">if</span> event.<span class="pl-smi">phase</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>moved<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        xDiff <span class="pl-k">=</span> event.<span class="pl-smi">x</span> <span class="pl-k">-</span> player1.<span class="pl-smi">touch</span>.<span class="pl-smi">x</span>
        yDiff <span class="pl-k">=</span> event.<span class="pl-smi">y</span> <span class="pl-k">-</span> player1.<span class="pl-smi">touch</span>.<span class="pl-smi">y</span>
        player1.<span class="pl-smi">touch</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> event.<span class="pl-smi">x</span>
        player1.<span class="pl-smi">touch</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> event.<span class="pl-smi">y</span>

        player1.<span class="pl-smi">moveWithFinger</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>
        player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> yDiff <span class="pl-c">--on finger-off, continue moving (will decelerate)</span>
    <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">sceneBattle:</span><span class="pl-en">update</span>(<span class="pl-smi">event</span>)
    <span class="pl-c">-- Sled Movement:</span>

    <span class="pl-c">-- move exactly with finger while finger is down</span>
    <span class="pl-k">if</span> player1.<span class="pl-smi">moveWithFinger</span> <span class="pl-k">==</span> <span class="pl-c1">true</span> <span class="pl-k">then</span>
        player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> player1.<span class="pl-smi">touch</span>.<span class="pl-smi">y</span> <span class="pl-k">-</span> player1.<span class="pl-smi">touchPosDiff</span>
    <span class="pl-k">else</span>
        <span class="pl-c">-- if finger is up, keep moving but decelerate</span>
        player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">+</span> player1.<span class="pl-smi">velocity</span>

        <span class="pl-k">if</span> player1.<span class="pl-smi">velocity</span> <span class="pl-k">&gt;</span> <span class="pl-c1">0</span> <span class="pl-k">then</span>
            player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> player1.<span class="pl-smi">velocity</span> <span class="pl-k">-</span> <span class="pl-c1">1</span>
        <span class="pl-k">elseif</span> player1.<span class="pl-smi">velocity</span> <span class="pl-k">&lt;</span> <span class="pl-c1">0</span> <span class="pl-k">then</span>
            player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> player1.<span class="pl-smi">velocity</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>
        <span class="pl-k">end</span>
    <span class="pl-k">end</span>

    <span class="pl-c">-- keep within screen bounds</span>
    <span class="pl-k">if</span> player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">&gt;</span> maxY <span class="pl-k">-</span> player1.<span class="pl-smi">halfHeight</span> <span class="pl-k">then</span>
        player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> maxY <span class="pl-k">-</span> player1.<span class="pl-smi">halfHeight</span>
        player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
    <span class="pl-k">elseif</span> player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">&lt;</span> minY <span class="pl-k">+</span> player1.<span class="pl-smi">halfHeight</span> <span class="pl-k">then</span>
        player1.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> minY <span class="pl-k">+</span> player1.<span class="pl-smi">halfHeight</span>
        player1.<span class="pl-smi">velocity</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>
    <span class="pl-k">end</span>

    <span class="pl-c">-- Balls:</span>
    <span class="pl-k">for</span> k,obj <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(collidables) <span class="pl-k">do</span>
        <span class="pl-c">-- movement:</span>
        obj.<span class="pl-smi">y</span> <span class="pl-k">=</span> obj.<span class="pl-smi">y</span> <span class="pl-k">+</span> obj.<span class="pl-smi">vec</span>.<span class="pl-smi">y</span>
        obj.<span class="pl-smi">x</span> <span class="pl-k">=</span> obj.<span class="pl-smi">x</span> <span class="pl-k">+</span> obj.<span class="pl-smi">vec</span>.<span class="pl-smi">x</span>

        <span class="pl-c">-- super simplistic bounce function. We put the ball on the screen edge rather than moving exactly</span>
        <span class="pl-k">if</span> obj.<span class="pl-smi">x</span> <span class="pl-k">&gt;</span> maxX <span class="pl-k">then</span>
            obj.<span class="pl-smi">x</span> <span class="pl-k">=</span> maxX
            obj.<span class="pl-smi">vec</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> <span class="pl-k">-</span>obj.<span class="pl-smi">vec</span>.<span class="pl-smi">x</span>
            <span class="pl-c">-- bullets bounce once</span>
            <span class="pl-k">if</span> obj.<span class="pl-smi">objType</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>bullet<span class="pl-pds">"</span></span> <span class="pl-k">then</span> obj.<span class="pl-smi">bulletFlag</span> <span class="pl-k">=</span> <span class="pl-c1">1</span> <span class="pl-k">end</span>
        <span class="pl-k">end</span>
        <span class="pl-k">if</span> obj.<span class="pl-smi">x</span> <span class="pl-k">&lt;</span> minX <span class="pl-k">then</span>
            obj.<span class="pl-smi">x</span> <span class="pl-k">=</span> minX
            obj.<span class="pl-smi">vec</span>.<span class="pl-smi">x</span> <span class="pl-k">=</span> <span class="pl-k">-</span>obj.<span class="pl-smi">vec</span>.<span class="pl-smi">x</span>
            <span class="pl-k">if</span> obj.<span class="pl-smi">objType</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>bullet<span class="pl-pds">"</span></span> <span class="pl-k">then</span> obj.<span class="pl-smi">bulletFlag</span> <span class="pl-k">=</span> <span class="pl-c1">1</span> <span class="pl-k">end</span>
        <span class="pl-k">end</span>
        <span class="pl-k">if</span> obj.<span class="pl-smi">y</span> <span class="pl-k">&gt;</span> maxY <span class="pl-k">then</span>
            obj.<span class="pl-smi">y</span> <span class="pl-k">=</span> maxY
            obj.<span class="pl-smi">vec</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> <span class="pl-k">-</span>obj.<span class="pl-smi">vec</span>.<span class="pl-smi">y</span>
        <span class="pl-k">end</span>
        <span class="pl-k">if</span> obj.<span class="pl-smi">y</span> <span class="pl-k">&lt;</span> minY <span class="pl-k">then</span>
            obj.<span class="pl-smi">y</span> <span class="pl-k">=</span> minY
            obj.<span class="pl-smi">vec</span>.<span class="pl-smi">y</span> <span class="pl-k">=</span> <span class="pl-k">-</span>obj.<span class="pl-smi">vec</span>.<span class="pl-smi">y</span>
        <span class="pl-k">end</span>

        <span class="pl-c">-- Collisions (cheap collisions, ignoring fact ball is rounded!)</span>
        <span class="pl-k">for</span> pK,player <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(players) <span class="pl-k">do</span>
            playerCollideYTop <span class="pl-k">=</span> player.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">+</span> player.<span class="pl-smi">collideY</span>
            playerCollideYBot <span class="pl-k">=</span> player.<span class="pl-smi">sled</span>.<span class="pl-smi">y</span> <span class="pl-k">-</span> player.<span class="pl-smi">collideY</span>

            <span class="pl-k">if</span> ((player.<span class="pl-smi">collideX</span> <span class="pl-k">&lt;</span> <span class="pl-c1">0</span> <span class="pl-k">and</span> obj.<span class="pl-smi">x</span> <span class="pl-k">&lt;</span> player.<span class="pl-smi">collideX</span>) <span class="pl-k">or</span> (player.<span class="pl-smi">collideX</span> <span class="pl-k">&gt;</span> <span class="pl-c1">0</span> <span class="pl-k">and</span> obj.<span class="pl-smi">x</span> <span class="pl-k">&gt;</span> player.<span class="pl-smi">collideX</span>))
                <span class="pl-k">and</span> obj.<span class="pl-smi">y</span> <span class="pl-k">&lt;</span> playerCollideYTop <span class="pl-k">and</span> obj.<span class="pl-smi">y</span> <span class="pl-k">&gt;</span> playerCollideYBot <span class="pl-k">then</span>

                player:<span class="pl-c1">TakeHit</span>()
                <span class="pl-k">local</span> fx <span class="pl-k">=</span> director:<span class="pl-c1">createCircle</span>({
                    x<span class="pl-k">=</span>obj.<span class="pl-smi">x</span>,y<span class="pl-k">=</span>obj.<span class="pl-smi">y</span>,
                    xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>,yAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>,
                    radius<span class="pl-k">=</span>ballRadius,
                    color<span class="pl-k">=</span>color.<span class="pl-smi">lightBlue</span>, strokeWidth<span class="pl-k">=</span><span class="pl-c1">0</span>})
                origin:<span class="pl-c1">addChild</span>(fx)
                tween:<span class="pl-c1">to</span>(fx, {radius<span class="pl-k">=</span>ballRadius<span class="pl-k">*</span><span class="pl-c1">3</span>, alpha<span class="pl-k">=</span><span class="pl-c1">0</span>, time<span class="pl-k">=</span><span class="pl-c1">0.3</span>, onComplete<span class="pl-k">=</span>NodeDestroy})

                <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>destroy obj <span class="pl-pds">"</span></span> <span class="pl-k">..</span> obj.<span class="pl-smi">name</span>)
                obj:<span class="pl-c1">removeFromParent</span>()
                collidables[obj.<span class="pl-smi">name</span>] <span class="pl-k">=</span> <span class="pl-c1">nil</span>

                <span class="pl-c">--replace destroyed ball</span>
                ballCreateFlag <span class="pl-k">=</span> ballCreateFlag <span class="pl-k">+</span> <span class="pl-c1">1</span>
                <span class="pl-k">break</span>
            <span class="pl-k">end</span>
        <span class="pl-k">end</span>
    <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">NodeDestroy</span>(<span class="pl-smi">target</span>)
    target:<span class="pl-c1">removeFromParent</span>()
<span class="pl-k">end</span></pre></div>

<p>In the battle setUp and tearDown events we register and cancel the event handlers:</p>

<div class="highlight highlight-lua"><pre>    system:<span class="pl-c1">addEventListener</span>({<span class="pl-s"><span class="pl-pds">"</span>touch<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>update<span class="pl-pds">"</span></span>}, sceneBattle)
    <span class="pl-c1">...</span>
    system:<span class="pl-c1">removeEventListener</span>({<span class="pl-s"><span class="pl-pds">"</span>touch<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>update<span class="pl-pds">"</span></span>}, sceneBattle)</pre></div>

<p>And that's it for our basic game logic.</p>

<p><img src="http://i1353.photobucket.com/albums/q663/GazDeaves/protoscreen_zpsacb418b1.png" alt="new game screenshot"></p>

<h2>
<a id="testing-on-device" class="anchor" href="#testing-on-device" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing on device</h2>

<p>I'm not gonna cover setting up for device testing in this post (check the basics here: <a href="http://quick-docs.madewithmarmalade.com/usingthelaunchpad.html">http://quick-docs.madewithmarmalade.com/usingthelaunchpad.html</a>) but we have an issue that our game is fixed to 640x480 resolution.</p>

<p>Initially we'll take the easiest, but not the most elegant, way to deal with this and just fix to landscape and stretch our app to the screen. Open resources/app.icf and add the following:</p>

<pre><code>[S3E]
DispFixRot=Landscape

[GL]
VirtualWidth=640
VirtualHeight=480
VirtualLetterbox=1
</code></pre>

<p>The source for the Wrong prototype v1 is up on Github here: github.com/nickmarmalade/wrong-prototype</p>

<h1>
<a id="building-a-marmalade-quick-game-part-4-api-best-practice" class="anchor" href="#building-a-marmalade-quick-game-part-4-api-best-practice" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building a Marmalade Quick Game part 4: API Best Practice</h1>

<p>This post goes into detail about all the important concepts and best-practice tips learnt in my initial few weeks working with Marmalade Quick. It takes a lot of concepts from my previous post on Lua and puts them into context with Marmalade Quick.</p>

<p>To find out more about Marmalade Quick, you can head over to <a href="http://madewithmarmalade.com/quick">this page</a> where you'll get the latest on the new version, as well as links to download so you can start coding straight away. If you have any burning questions that aren't covered in this series, you can head over to our developer network, <a href="https://devnet.madewithmarmalade.com/index.html">Marmalade Answers</a>, where you'll find helpful tips from our community and can even post your own requests for help.</p>

<h2>
<a id="arrays-vs-tables" class="anchor" href="#arrays-vs-tables" aria-hidden="true"><span class="octicon octicon-link"></span></a>Arrays vs Tables</h2>

<p>Variable length Lua arrays can be confusing in Lua! (see 'Tables as "Arrays"' in the Lua post)</p>

<p>If you don't need to use contiguous integer values to access items in a list (e.g. you don't need them in a given order when looping though) then you should probably just stick to plain tables. You can loop through items in a table with a for loop. If you need a unique value to use for the key to an item and your item is (or contains as a member) a Quick "node" object, then you can just use <code>myNode.name</code> to get a guaranteed unique ID to use as the key. Unlike an array, you can also safely nil a table value in a <code>pairs()</code> loop which makes destroying game objects easy.</p>

<p>Example:</p>

<div class="highlight highlight-lua"><pre>myNodes <span class="pl-k">=</span> {}
node1 <span class="pl-k">=</span> director:<span class="pl-c1">createNode</span>(<span class="pl-c1">...</span>)
node2 <span class="pl-k">=</span> director:<span class="pl-c1">createNode</span>(<span class="pl-c1">...</span>)
myNodes[node1.<span class="pl-smi">name</span>] <span class="pl-k">=</span> node1
myNodes[node2.<span class="pl-smi">name</span>] <span class="pl-k">=</span> node2
<span class="pl-k">for</span> key,value <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(myNodes) <span class="pl-k">do</span>
    <span class="pl-c">--value is the node</span>
    <span class="pl-c">--key is node.name</span>

    value <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    <span class="pl-c">-- This will only set the local reference "value", not affect the table!</span>
    <span class="pl-c">-- myNodes[key] will still return the node now, not nil.</span>

    myNodes[key] <span class="pl-k">=</span> <span class="pl-c1">nil</span>
    <span class="pl-c">-- If this index referred to a table (it does since "nodes" are tables), the object is no longer referenced by mNodes and will be garbage collected when appropriate. Note that we still have a reference to it, e.g. "node1", so that wont happen till that's also nilled.</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="using-object-oriented-design" class="anchor" href="#using-object-oriented-design" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Object Oriented Design</h2>

<p>Out of the box, Lua basically only supports values (numbers and strings) and key-indexed tables. But you can use tables to implement a wide range of other data types, including class-like objects. You'll almost definitely want to implement classes of some sort for a game. Quick's own object types like the node also provide their own object oriented functionality.</p>

<h3>
<a id="creating-classes" class="anchor" href="#creating-classes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating Classes</h3>

<p>Read 'Tables as "classes" and the hidden "self" reference' in the introduction to Lua blog post above for info on creating basic classes in Lua. That method uses metatables to create classes. Quick provides some helpers to make this easier, namely the <code>baseClas</code>s global and the <code>inheritsFrom()</code> function. These implement the metatables trickery for you so you dont have to worry about how to do that. You can create new classes by just calling <code>myClass = inheritsFrom(baseClass)</code> and then implementing new() and init() functions for your class. You can then also do single inheritance using <code>myOtherNewClass = inheritsFrom(myClass)</code>. See Lua and object orientation for a guide to doing this.</p>

<p>These methods works well for classes you create yourself, but you cannot use them to inherit from Quick's node objects...</p>

<h3>
<a id="classes-and-quick-objects-vs-lua-tables" class="anchor" href="#classes-and-quick-objects-vs-lua-tables" aria-hidden="true"><span class="octicon octicon-link"></span></a>Classes and Quick objects vs. Lua tables</h3>

<p><strong>NB: The "objects" and "libraries" provided with Quick look like lua tables. However, it is important to know that Quick objects are not actually tables! They are userdata types.</strong></p>

<p>The userdata type allows arbitrary C data to be stored as a Lua variable. Userdata types are used to represent new types created by an application or library written in C. Internally, Quick uses Lua's C binding functionality to expose C objects (from the fast C++ Quick engine) to the Lua API, and it creates metadata types to do this. You don't need to understand how this works at all, but it means that while Quick's built in objects like nodes and sprites look like Lua tables, you cannot always use them in the same way as tables.</p>

<p>The notable constraints for Quick's metadata objects are:</p>

<ul>
<li>Nodes are always created by the director, using <code>director:createXXX()</code> functions. This means that you cant just have an "empty" object that you can tweak values for before creating and pushing into the scene. They exist the moment the director creates them. You can however hide a visual node using <code>myNode.isVisible=false</code> or move it out of the current scene using <code>myNode:removeFromParent()</code> while keeping a handle to it until it is needed later.</li>
<li>You cannot use <code>setmetatable()</code> with metadata.</li>
</ul>

<p>The two constraints above collectively mean that <strong>you cannot use Quick's node objects with <code>inheritsFrom()</code> or easily create a class that inherits a Quick object</strong>. That means that, for example, if you want to have a class that encapsulates all the data for your player in your game, you cannot have a Player class that inherits from a Quick sprite. You would create a Player class, and then have to have the sprite as a member of the Player.</p>

<p>You can directly access member values and functions of Quick's objects just as with tables. That includes non-documented internals - remember that Quick is open source so you can view and edit the Lua internals. Lua internal code all lives in the "quicklua" folder of your app. You can also add values, so for example with our Player example above you could create a sprite and then add a .player value to the sprite which points to the Player the sprite belongs to.</p>

<p>Quick's functions use either the "." operator or the ":" operator. Functions declared with ":" versions will be automatically passed a self parameter (a reference to the object/table the function is a member of) when they are called. Quick's "node" object and its descendants like "sprite" and "circle" have functions for which the self parameter will give you access to the unique node involved, which is useful in callback style situations.</p>

<h2>
<a id="using-marmalade-quicks-node-object" class="anchor" href="#using-marmalade-quicks-node-object" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using Marmalade Quick's Node Object</h2>

<p>If you need to create a class for some object in your app, remember that you cannot re-use/inherit a Marmalade Quick node for the reasons described above. You need to create a custom class and then add any nodes needed as members. For example:</p>

<div class="highlight highlight-lua"><pre>myShip <span class="pl-k">=</span> {}
myShip.<span class="pl-smi">health</span> <span class="pl-k">=</span> <span class="pl-c1">10</span>
myShip.<span class="pl-smi">img</span> <span class="pl-k">=</span> director:<span class="pl-c1">createSprint</span>(<span class="pl-c1">...</span>)</pre></div>

<p>There are many functions that trigger events - for example, <code>node:addTimer()</code> or <code>tween:to()</code>. These functions will have one parameter that is the function to call when they complete (a "callback"), for example the function when the timer expires (funcortable) or when the tween is over (<code>onComplete</code>). They also either take a reference to the node involved or implicitly know the node as they are member functions of it (e.g. <code>myNode:addTimer</code>). You will usually want a handle back to the object that the event is related to when the event occurs, for example if you set a timer after which you want an object to "explode". Quick handles this by passing an table called event to the callback function, where event.target is the object. Often you want a handle to your own game class, i.e. myShip above, and not the Quick node so you will have to create a pointer from the node back to your object.</p>

<div class="highlight highlight-lua"><pre>myShip.<span class="pl-smi">img</span>.<span class="pl-smi">ship</span> <span class="pl-k">=</span> myShip <span class="pl-c">--pointer from Quick object back to custom one</span>
myShip.<span class="pl-smi">img</span>:<span class="pl-c1">addTimer</span>(Explode, <span class="pl-c1">20</span>, <span class="pl-c1">1</span>) <span class="pl-c">--start a timer that will internally track the img node that called it</span>
<span class="pl-k">function</span> <span class="pl-en">Explode</span>(<span class="pl-smi">event</span>) <span class="pl-c">--when timer ends, event.target is the img node that called it</span>
    event.<span class="pl-smi">target</span>.<span class="pl-smi">ship</span>:<span class="pl-c1">MakeExplode</span>() <span class="pl-c">--we can get the ship back from the img via our .ship reference</span>
<span class="pl-k">end</span></pre></div>

<p>Quick timer functions can either be called from the global system object or from a node (or descendant of node like vector, sprite, circle, etc.) If you use the node version (e.g. <code>myNode:addTimer(myFunction,...)</code> then the callback function (e.g. <code>myFunction</code> here) gets a handle back to the node itself via event.target as shown above. If the node gets destroyed then the timer will also automatically cancel itself (the timer gets nil-ed with the node). If you use <code>system:addTimer(funcortable,...)</code>, the only way to track an object is by passing the object as the funcortable parameter (see Functions with "funcortable" parameters below). This is less flexible since the object needs to have a function matching the event name, so it is recommended to use <code>node:addTimer</code>, etc. if dealing with nodes.</p>

<p>Here's an example of a class using timers, a node and the inheritsFrom </p>

<div class="highlight highlight-lua"><pre><span class="pl-k">function</span>:
cSpaceShip <span class="pl-k">=</span> <span class="pl-c1">inheritsFrom</span>(baseClass)

<span class="pl-k">function</span> <span class="pl-en">cSpaceShip:</span><span class="pl-en">new</span>(<span class="pl-smi">health, ammo, startX, startY</span>)
    <span class="pl-k">local</span> o <span class="pl-k">=</span> cSpaceShip:<span class="pl-c1">create</span>()

    o.<span class="pl-smi">visualShip</span> <span class="pl-k">=</span> director:<span class="pl-c1">createNode</span>({x<span class="pl-k">=</span>startX, y<span class="pl-k">=</span>startY, <span class="pl-c1">...</span>})
    o.<span class="pl-smi">visualShip</span>.<span class="pl-smi">ship</span> <span class="pl-k">=</span> o
    o.<span class="pl-smi">health</span> <span class="pl-k">=</span> health
    o.<span class="pl-smi">ammo</span> <span class="pl-k">=</span> ammo
    <span class="pl-c1">...</span>
    add other visual stuff as children
    set other internal values
    etc
    <span class="pl-c1">...</span>
    <span class="pl-k">return</span> o
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">RestoreHealth</span>(<span class="pl-smi">event</span>)
    event.<span class="pl-smi">target</span>.<span class="pl-smi">ship</span>.<span class="pl-smi">health</span> <span class="pl-k">=</span> event.<span class="pl-smi">target</span>.<span class="pl-smi">ship</span>.<span class="pl-smi">health</span> <span class="pl-k">+</span> <span class="pl-c1">1</span>
<span class="pl-k">end</span>

myShip <span class="pl-k">=</span> cSpaceShip:<span class="pl-c1">new</span>(<span class="pl-c1">10</span>,<span class="pl-c1">100</span>, <span class="pl-c1">50</span>,<span class="pl-c1">50</span>)
myShip:<span class="pl-c1">addTimer</span>(RestoreHealth, <span class="pl-c1">20</span>, <span class="pl-c1">0</span>)</pre></div>

<h2>
<a id="marmalade-quick-parent-and-child-nodes-and-using-local-coordinate-spaces" class="anchor" href="#marmalade-quick-parent-and-child-nodes-and-using-local-coordinate-spaces" aria-hidden="true"><span class="octicon octicon-link"></span></a>Marmalade Quick Parent and Child Nodes and Using Local Coordinate Spaces</h2>

<p>Marmalade Quick uses descendants of nodes - circles, vectors, sprites, etc - to display and position visual objects. Each object of these types has a visual element, a position, various attributes, and can be made a child of other nodes. Children are positioned relative to their parent's x &amp; y origin values (i.e. the values given as the parent's x= and y= constructor values). Nodes that aren't explicitly made a child of another node are children of the scene. The scene itself is a type of node and has its x &amp; y origin at the bottom left of the screen.</p>

<p>All nodes are drawn with their bottom left corner at their x &amp; y origin. One type that is slightly different is vectors/lines which has it's origin at it's specified x &amp; y position, with its various points/lines relative to that position (since you can have negative points in a line).</p>

<p>Marmalade Quick has a concept of "anchors" which can be set for any object. Anchors move the object visually from it's x &amp; y position, by a proportion of the size of the node itself. You specify x &amp; y anchors as a values from 0 to 1, not in pixels. <code>xAnchor=0</code> means position in default place. <code>xAnchor=1</code> means move the "anchor" to the right by the width of the node, which effectively means that the image is drawn to the left of the default position, so that its right edge is at the nodes x,y position. Children of a node are positioned relative to the node's original x,y position and not its anchor offset. The point of anchors is basically to allow you to position sprites in a more intuitive way. For example a "wheel" sprite might want the anchor at (0.5,0.5) so it is centred at the node's x,y position.</p>

<p><strong>NB: Anchors are not designed for creating some sort of local coordinate system for an object. Do not try to use them to position children relative to the parent!</strong></p>

<p>For example, if you want to position a parent at (100,50) and a child at 10,10 from a specific point on the parent, you can't easily use the anchor to do that since children do not inherit the anchor offset. Also, the anchor values are fractions of the parent size, which is very unintuitive for positioning in pixels. You could use the anchors in this way, but then you also will likely end up setting the parent's x &amp; y position to something unintuitive and are limited to 0-1*width or height to offset by.</p>

<p>What if you want to create a local coordinate space to position a group of objects relative to? The simplest example is if you want to have the centre of the screen as you scene origin. To achieve this, just use a non-visual "node" object (not a sprite, circle, etc) as the parent, by calling <code>director:createNode(...)</code>. You can then treat this as a local origin by adding other nodes as children of it. Similarly, you might want a local origin so objects can rotate around some given point, and again a "dummy node" is the solution.</p>

<p>Example - A ship object, positioned by it's centre point and relative to the screen centre, with 2 gun objects that rotate around a point on the front of the ship:
worldOrigin = director:createNode(appwidth/2,appheight/2)</p>

<div class="highlight highlight-lua"><pre>myShip <span class="pl-k">=</span> director:<span class="pl-c1">createSprite</span>({<span class="pl-s"><span class="pl-pds">"</span>myship.png<span class="pl-pds">"</span></span>, x<span class="pl-k">=</span><span class="pl-c1">100</span>, y<span class="pl-k">=</span><span class="pl-c1">100</span>, xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>, yAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>})
worldOrigin:<span class="pl-c1">addChild</span>(myShip)
<span class="pl-c">-- ship png is facing upwards by default, using anchor to have the displayed sprite centred on its position.</span>
<span class="pl-c">-- children are still positioned relative to x &amp; y (i.e. middle of the diplsyed ship) as they dont inherit anchors.</span>

shipGuns <span class="pl-k">=</span> director:<span class="pl-c1">createNode</span>(x<span class="pl-k">=</span><span class="pl-c1">0</span>,y<span class="pl-k">=</span><span class="pl-c1">30</span>)
myShip:<span class="pl-c1">addChild</span>(shipGuns) <span class="pl-c">--guns node now sits towards front of ship (30 pixel offset)</span>

gunLeft <span class="pl-k">=</span> <span class="pl-c1">createSprite</span>({<span class="pl-s"><span class="pl-pds">"</span>gun.png<span class="pl-pds">"</span></span>, x<span class="pl-k">=-</span><span class="pl-c1">10</span>, y<span class="pl-k">=</span><span class="pl-c1">0</span>, xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>, yAnchor<span class="pl-k">=</span><span class="pl-c1">0</span>})
shipGuns:<span class="pl-c1">addChild</span>(gunLeft)
gunRight <span class="pl-k">=</span> <span class="pl-c1">createSprite</span>({<span class="pl-s"><span class="pl-pds">"</span>gun.png<span class="pl-pds">"</span></span>, x<span class="pl-k">=</span><span class="pl-c1">10</span>, y<span class="pl-k">=</span><span class="pl-c1">0</span>, xAnchor<span class="pl-k">=</span><span class="pl-c1">0.5</span>, yAnchor<span class="pl-k">=</span><span class="pl-c1">0</span>})
shipGuns:<span class="pl-c1">addChild</span>(gunRight) <span class="pl-c">-- guns are positioned to sides of non-visual pivot point</span></pre></div>

<h2>
<a id="destroying-objects-and-removing-them-from-the-scene" class="anchor" href="#destroying-objects-and-removing-them-from-the-scene" aria-hidden="true"><span class="octicon octicon-link"></span></a>Destroying Objects and Removing Them From the Scene</h2>

<p>The correct way to "destroy" an object is to call <code>myNode:removeFromParent()</code>, or <code>myParent:removeChild(myNode)</code> and then make sure all references to myNode in your code are set to nil. At any point, an active node will have a parent node. This might be another node - e.g. one sprite is the child of another via <code>node:addChild()</code> - or it may be the current scene. director:createNode/Sprite/etc. makes the new node a child of the current scene (the scene itself is a type of node). Nodes only ever have one parent; if a node already has a parent, calling <code>myNewParent:addChild(myNode)</code> will automatically remove it from it's existing parent. Often the only variable pointing to a node will be another node's .children table so you won't have to explicitly nil anything after calling <code>removeFromParent()</code>. See <a href="http://docs.madewithmarmalade.com/display/MD/Cleaning+up+scene+texture+resources+-+sprites%2C+atlases%2C+animations+and+fonts">Cleaning up scene texture resources - sprites, atlases, animations and fonts</a> in the Quick docs for info on cleaning up any resources like textures once you have finished with them.</p>

<h2>
<a id="events" class="anchor" href="#events" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events</h2>

<p>In a nutshell, events work as follows:</p>

<ul>
<li>The event itself is a table that is returned to a handler function in some specific situation.</li>
<li>You declare functions to handle events. These functions take a single parameter which the event object (table) will be passed to. Call the param what you want, but it's good practice to use "event"! e.g. <code>myHandlerFunction = function(event)</code>.</li>
<li>You register for events by calling handler registration functions of relevant objects.</li>
<li>The objects in Marmalade Quick that handle events are:</li>
<li>The global "system" object - add handlers with <code>system:addEventListener listOfEventNames, funcortable)</code>.</li>
<li>"nodes" - add handlers with <code>myNode:addEventListener(listOfEventNames, funcortable)</code>.</li>
<li>There are also events specifically for "scenes" (a special type of node) which occur when <code>director:moveToScene()</code> is called.</li>
<li>For timer events, event.timer is a handle to the timer itself.</li>
<li>For timer or tween events that were called for a node, <code>event.target</code> is a handle to the node.</li>
</ul>

<h2>
<a id="functions-with-funcortable-parameters" class="anchor" href="#functions-with-funcortable-parameters" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functions with "funcortable" Parameters</h2>

<p>Functions documented as having a "funcortable" parameter can be passed either:</p>

<ul>
<li>a reference to a single function of any name</li>
<li>a reference to a table, which must contain a member function (or functions) named the same as the event(s) being registered</li>
</ul>

<p>Typically, funcortables are useful when working in an object-oriented fashion. You can pass a class-style object as the funcortable value and give that object functions that match the expected names. Note that the event names are passed as a list (table) so you can register lots of events at once. Simple example.</p>

<div class="highlight highlight-lua"><pre>sceneMainMenu <span class="pl-k">=</span> director:<span class="pl-c1">createScene</span>()
sceneMainMenu:<span class="pl-c1">addEventListener</span>({<span class="pl-s"><span class="pl-pds">"</span>setUp<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>exitPostTransition<span class="pl-pds">"</span></span>}, sceneMainMenu)

<span class="pl-k">function</span> <span class="pl-en">sceneMainMenu:</span><span class="pl-en">touch</span>(<span class="pl-smi">event</span>)
    <span class="pl-k">if</span> event.<span class="pl-smi">phase</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>began<span class="pl-pds">"</span></span> <span class="pl-k">then</span>
        director:<span class="pl-c1">moveToScene</span>(nextScene, {transitionType<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>slideInR<span class="pl-pds">"</span></span>, transitionTime<span class="pl-k">=</span><span class="pl-c1">1.0</span>})
        system:<span class="pl-c1">removeEventListener</span>(<span class="pl-s"><span class="pl-pds">"</span>touch<span class="pl-pds">"</span></span>, sceneMainMenu)
    <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">sceneMainMenu:</span><span class="pl-en">setUp</span>(<span class="pl-smi">event</span>)
    <span class="pl-c">-- setup scene objects here</span>
    system:<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">"</span>touch<span class="pl-pds">"</span></span>, sceneMainMenu)
<span class="pl-k">end</span>

<span class="pl-k">function</span> <span class="pl-en">sceneMainMenu:</span><span class="pl-en">exitPostTransition</span>(<span class="pl-smi">event</span>)
    <span class="pl-c">-- destroy scene objects here</span>
<span class="pl-k">end</span></pre></div>

<p>Note that because the functions above are declared with ":" syntax, they can also access the <code>sceneMainMenu</code> object itself using "self". This is the main upside of using a table. A simple function is useful if you want to register lots of functions of the same type of event. For example if you want to add a timer to a node, passing the node as the funcortable value means you can only register a single function, <code>myNode:timer</code>, whereas you likely want to have multiple timer events on one object. In this case you need to use a plain function and store your own pointer from the timer to the node if needed.</p>

<h2>
<a id="debugging-and-testing" class="anchor" href="#debugging-and-testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Debugging and Testing</h2>

<p>When a Lua error occurs, the app will output info to the console but will usually continue running unless an assert or serious error is encountered in the internal C++ code. This can make finding the error in the console awkward as trace will keep running.</p>

<p>A good solution is to add the following to your app.icf:</p>

<pre><code>[s3e] WindowSuspendOnFocusLoss=1
</code></pre>

<p>This will suspend the app when the window is out of focus, so you can just click on the trace console to pause everything.</p>

<p>Note that you're app won't automatically suspend timers, animations, etc on suspend events. Timer callback events will queue internally and then fire in rapid succession when the app resumes! But you can pause all timers and tweens manually yourself using <code>node:pauseTimers()</code> etc.</p>

<p><strong>Note: The info below is for Marmalade 6. With Marmalade 7.0 and newer, Quick has been integrated into the new shared "hub" GUI and can be used with most platforms out of the box. See <a href="http://docs.madewithmarmalade.com/display/MD/Using+the+Hub">Using the Hub</a> in the official docs</strong></p>

<p>The launchpad lets you pick "Debug" or "Release" mode with a radio button at the top for both Simulator and devices. Debug uses versions of the C++ Marmalade Quick pre-built binary and Marmalade loader (platform abstraction layer) that include tracing and asserts but will run slower; Release has no C++/native debug info or events. Note that option does not affect the Lua code at all! By efault dbg.print() will continue to output to console even in release mode.</p>

<p>To control lua debugging, you need to use config.lua (see <a href="http://quick-docs.madewithmarmalade.com/ConfiguringYourApp.html#config-lua-file">http://quick-docs.madewithmarmalade.com/ConfiguringYourApp.html#config-lua-file</a>) Essentially, Lua debugging features are mostly turned on by default and will slow your app down a <em>lot</em>, so for the store and when testing performance, you should do the following:</p>

<ul>
<li>Add a config.lua file next to your main.lua</li>
<li>Set the following in config.lua:</li>
</ul>

<div class="highlight highlight-lua"><pre>config <span class="pl-k">=</span>
{
    debug <span class="pl-k">=</span>
    {
        general <span class="pl-k">=</span> <span class="pl-c1">false</span>,
        assertDialogs <span class="pl-k">=</span> <span class="pl-c1">false</span>,
        typeChecking <span class="pl-k">=</span> <span class="pl-c1">false</span>,
        traceGC <span class="pl-k">=</span> <span class="pl-c1">false</span>,
    }
}</pre></div>

<p>In Marmalade Quick 1.0 when launching the Simulator from the Launchpad, even if you pick Release mode it will still use the debug loader which means there will be a performance hit - see below for a workaround. This does not affect device builds.</p>

<p>If you want someone to test your build without a Marmalade SDK or importing your Quick project, you can use the standard Deploy Tool (Advanced &gt; Launch Deploy Tool) to do Windows/Mac x86 deployments if you have a Plus license or higher. The Deploy Tool is also useful as you can separately select between debug and release versions of the Marmalade loader (abstraction layer) and Quick app (C++ implementation of Quick). Release builds will run at full speed while debug ones will output internal debug info to trace but run slower. If you use the Deploy Tool release builds will use the release loader by default. If you have an Indie or community license, you can still pick Windows/Mac <em>Simulator</em> to test on desktop at full speed. The difference between Simulator and full deployment is that Simulator gives you settings menus and requires the SDK to run.</p>

<p>You probably want to test deployed builds at specific resolutions. Desktop deployed builds run windowed at 800x600 by default. Use [s3e] WinHeight= WinWidth= WinResizable= ICF options in app.icf to specify window size and behaviour when you don't have the Simulator menus.</p>

<h2>
<a id="upgrading-projects-from-older-quick-versions" class="anchor" href="#upgrading-projects-from-older-quick-versions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Upgrading Projects From Older Quick Versions</h2>

<p>We changed some APIs and broke back-compatibility between the beta and 1.0 Quick release version! If upgrading a project, you must replace the "quicklua" folder in the old project with a copy of the new one found in /quick/data/quicklua Some minor breaking changes were also added in Quick 1.1. See the change log in the Quick docs for more info.</p>

<h2>
<a id="what-happened-to-wrong" class="anchor" href="#what-happened-to-wrong" aria-hidden="true"><span class="octicon octicon-link"></span></a>What Happened to "Wrong"?</h2>

<p>My little Weaponified Reverse pONG game is moving along slowly. As a proof of concept, I've uploaded a version (that's slightly more advanced than the one in part 3...) to the BlackBerry World store for BlackBerry 10. Treat that as a preview of the weapons, effects and retro styling I'll be covering in the next post: <a href="http://appworld.blackberry.com/webstore/content/24134883/">View and download Wrong for BlackBerry 10</a></p>

<h1>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authors and Contributors</h1>

<p>The prototype and blog are both written by Nick Smith @nickmarmalade.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/nickchops/wrong-prototype/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/nickchops/wrong-prototype/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/nickchops/wrong-prototype"></a> is maintained by <a href="https://github.com/nickchops">nickchops</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>
